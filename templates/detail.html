<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
<link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
<script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}" type="text/javascript"></script>
<title>è¯é¢˜è¯¦æƒ…</title>
</head>

<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/logo1.jpg') }}"/></a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">ä¸ªäººä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">æ¶ˆæ¯ä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">è¯¾ç¨‹è®ºå›</a>
                    <div class="nav_slide">
                        <div class="nav_slide1">
                            <a href="{{ url_for('news_center') }}">è¯¾ç¨‹è®¨è®º<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
                            <a href="{{ url_for('course_discussion') }}">å‘å¸ƒè¯é¢˜<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
        </div>
    </div>
    </li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">è¯¾ç¨‹æ¨è</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">é€‰è¯¾ä¸­å¿ƒ</a></li>
    <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">è¯¾ç¨‹è¿›åº¦</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">é¦–é¡µ</a></li>
    </ul>
</div>
<script>
    $(".nav_1").mouseenter(function(){
        $(this).find(".nav_slide").slideDown()
    });
    $(".nav_1").mouseleave(function(){
        $(".nav_slide").slideUp()
    });
</script>
</div>

    <!-- è¯é¢˜è¯¦æƒ…ä¸»ä½“å†…å®¹ -->
    <div class="detail_container">
        <div class="detail_card">
            <!-- è¯é¢˜å¤´éƒ¨ -->
            <div class="topic_header_detail">
                <div class="topic_title_section">
                    <h1 class="topic_title_main">{{ title[0] }}</h1>
                    <div class="topic_meta_info">
                        <span class="meta_item">
                            <span class="meta_icon">ğŸ‘¤</span>
                            <span class="meta_text">{{ title[2] }}</span>
                        </span>
                        <span class="meta_item">
                            <span class="meta_icon">ğŸ•</span>
                            <span class="meta_text">{{ title[3] }}</span>
                        </span>
                        <a href="{{ url_for('news_center') }}" class="back_to_forum">â† è¿”å›è®ºå›</a>
                    </div>
                </div>
</div>

            <!-- è¯é¢˜å†…å®¹ -->
            <div class="topic_content_detail">
                <div class="content_text">{{ title[1] }}</div>
            </div>

            <!-- å›å¤åŒºåŸŸ -->
            <div class="replies_section">
                <div class="replies_header">
                    <h3 class="replies_title">
                        <span class="replies_count" id="replies-count">{{ result|length if result else 0 }}</span> æ¡å›å¤
                    </h3>
                    <button class="btn_refresh" id="refresh-btn">ğŸ”„ åˆ·æ–°</button>
                </div>

                <!-- å›å¤åˆ—è¡¨ -->
                <div class="replies_list" id="replies-list">
                    {% if result %}
                        {% for message in result %}
                        <div class="reply_item">
                            <div class="reply_header">
                                <div class="reply_author">
                                    <span class="author_name">{{ message[2] }}</span>
                                    {% if 'è€å¸ˆ' in message[2] or 'æ•™æˆ' in message[2] %}
                                    <span class="author_badge teacher_badge">æ•™å¸ˆ</span>
                                    {% endif %}
                                </div>
                                <span class="reply_time">{{ message[3] if message[3] else 'æœªçŸ¥æ—¶é—´' }}</span>
                            </div>
                            <div class="reply_content">
                                {{ message[1] }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no_replies">æš‚æ— å›å¤ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡å›å¤å§ï¼</div>
                    {% endif %}
                </div>

                <!-- å›å¤è¡¨å• -->
                <div class="reply_form_section">
                    <h4 class="form_title">å‘è¡¨å›å¤</h4>
                    <form id="reply-form">
                        <textarea id="reply-content" name="comments" placeholder="è¯·è¾“å…¥æ‚¨çš„å›å¤å†…å®¹..." required rows="6"></textarea>
                        <div class="form_footer">
                            <div class="char_count">
                                <span id="reply-char-count">0</span> / 1000 å­—
                            </div>
                            <button type="submit" class="btn_submit_reply" id="submit-reply-btn">å‘è¡¨å›å¤</button>
</div>
</form>
                </div>
            </div>
        </div>
</div>
</div>

<script>
$(function() {
    var topicId = "{{ question }}";
    
    // å­—ç¬¦è®¡æ•°
    $("#reply-content").on("input", function() {
        var length = $(this).val().length;
        $("#reply-char-count").text(length);
        
        if (length > 1000) {
            $(this).val($(this).val().substring(0, 1000));
            $("#reply-char-count").text(1000);
            showNotification("å›å¤å†…å®¹ä¸èƒ½è¶…è¿‡1000å­—", "warning");
        }
    });
    
    // åˆ·æ–°å›å¤åˆ—è¡¨
    $("#refresh-btn").click(function() {
        loadReplies();
    });
    
    // åŠ è½½å›å¤åˆ—è¡¨
    function loadReplies() {
        $.ajax({
            url: "/api/get_topic_replies",
            type: "GET",
            data: { topic_id: topicId },
            success: function(res) {
                if (res.success && res.data) {
                    renderReplies(res.data);
                    $("#replies-count").text(res.data.length);
                }
            },
            error: function() {
                showNotification("åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", "error");
            }
        });
    }
    
    // æ¸²æŸ“å›å¤åˆ—è¡¨
    function renderReplies(replies) {
        if (replies.length === 0) {
            $("#replies-list").html('<div class="no_replies">æš‚æ— å›å¤ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡å›å¤å§ï¼</div>');
            return;
        }
        
        var html = '';
        replies.forEach(function(reply) {
            var teacherBadge = '';
            if (reply.commenter && (reply.commenter.indexOf('è€å¸ˆ') >= 0 || reply.commenter.indexOf('æ•™æˆ') >= 0)) {
                teacherBadge = '<span class="author_badge teacher_badge">æ•™å¸ˆ</span>';
            }
            
            html += `
                <div class="reply_item">
                    <div class="reply_header">
                        <div class="reply_author">
                            <span class="author_name">${reply.commenter || 'åŒ¿åç”¨æˆ·'}</span>
                            ${teacherBadge}
    </div>
                        <span class="reply_time">${reply.create_time || 'æœªçŸ¥æ—¶é—´'}</span>
    </div>
                    <div class="reply_content">${reply.comments || ''}</div>
    </div>
            `;
        });
        
        $("#replies-list").html(html);
    }
    
    // æäº¤å›å¤
    $("#reply-form").submit(function(e) {
        e.preventDefault();
        
        var content = $("#reply-content").val().trim();
        
        // éªŒè¯
        if (!content) {
            showNotification("è¯·è¾“å…¥å›å¤å†…å®¹", "error");
            $("#reply-content").focus();
            return;
        }
        
        if (content.length < 5) {
            showNotification("å›å¤å†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—", "error");
            $("#reply-content").focus();
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        var submitBtn = $("#submit-reply-btn");
        submitBtn.prop("disabled", true).text("æäº¤ä¸­...");
        
        // æäº¤å›å¤
        $.ajax({
            url: "/detail/" + topicId,
            type: "POST",
            data: {
                comments: content
            },
            success: function(response) {
                showNotification("å›å¤å‘è¡¨æˆåŠŸï¼", "success");
                $("#reply-content").val("");
                $("#reply-char-count").text(0);
                
                // åˆ·æ–°å›å¤åˆ—è¡¨
                setTimeout(function() {
                    loadReplies();
                }, 500);
            },
            error: function(xhr) {
                var errorMsg = "å›å¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
                if (xhr.responseText) {
                    try {
                        var error = JSON.parse(xhr.responseText);
                        if (error.message) {
                            errorMsg = error.message;
                        }
                    } catch(e) {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTMLé”™è¯¯é¡µé¢
                        if (xhr.status === 200) {
                            // å¯èƒ½æ˜¯æˆåŠŸä½†è¿”å›äº†HTML
                            showNotification("å›å¤å‘è¡¨æˆåŠŸï¼", "success");
                            $("#reply-content").val("");
                            $("#reply-char-count").text(0);
                            setTimeout(function() {
                                loadReplies();
                            }, 500);
                            return;
                        }
                    }
                }
                showNotification(errorMsg, "error");
                submitBtn.prop("disabled", false).text("å‘è¡¨å›å¤");
            },
            complete: function() {
                setTimeout(function() {
                    if (submitBtn.prop("disabled")) {
                        submitBtn.prop("disabled", false).text("å‘è¡¨å›å¤");
                    }
                }, 2000);
            }
        });
    });
    
    // æ˜¾ç¤ºé€šçŸ¥å‡½æ•°
    function showNotification(message, type) {
        type = type || "info";
        var notification = $('<div class="notification notification-' + type + '">' + message + '</div>');
        $("body").append(notification);
        
        setTimeout(function() {
            notification.addClass("show");
        }, 10);
        
        setTimeout(function() {
            notification.removeClass("show");
            setTimeout(function() {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°å›å¤è¡¨å•ï¼ˆå¦‚æœURLåŒ…å«é”šç‚¹ï¼‰
    if (window.location.hash === '#reply') {
        setTimeout(function() {
            $("html, body").animate({
                scrollTop: $(".reply_form_section").offset().top - 100
            }, 500);
            $("#reply-content").focus();
        }, 300);
    }
});
</script>

<style>
/* è¯¦æƒ…é¡µå®¹å™¨ */
.detail_container {
    width: 1000px;
    margin: 30px auto;
    min-height: 600px;
}

.detail_card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* è¯é¢˜å¤´éƒ¨ */
.topic_header_detail {
    padding: 30px;
    border-bottom: 1px solid #f0f0f0;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.topic_title_main {
    margin: 0 0 15px 0;
    font-size: 24px;
    font-weight: 600;
    color: #333;
    line-height: 1.4;
}

.topic_meta_info {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.meta_item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #666;
}

.meta_icon {
    font-size: 16px;
}

.back_to_forum {
    margin-left: auto;
    color: #003d79;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.3s;
}

.back_to_forum:hover {
    text-decoration: underline;
}

/* è¯é¢˜å†…å®¹ */
.topic_content_detail {
    padding: 30px;
    border-bottom: 1px solid #f0f0f0;
}

.content_text {
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* å›å¤åŒºåŸŸ */
.replies_section {
    padding: 30px;
}

.replies_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.replies_title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.replies_count {
    color: #003d79;
}

.btn_refresh {
    padding: 6px 16px;
    background: #f5f7fa;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    color: #666;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn_refresh:hover {
    background: #e8f0fe;
    border-color: #003d79;
    color: #003d79;
}

/* å›å¤åˆ—è¡¨ */
.replies_list {
    margin-bottom: 30px;
}

.reply_item {
    padding: 20px;
    margin-bottom: 16px;
    background: #f9fafb;
    border-radius: 6px;
    border-left: 3px solid #003d79;
    transition: all 0.3s;
}

.reply_item:hover {
    background: #f0f4ff;
    box-shadow: 0 2px 8px rgba(0,61,121,0.1);
}

.reply_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.reply_author {
    display: flex;
    align-items: center;
    gap: 10px;
}

.author_name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.author_badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
}

.teacher_badge {
    background: #fff7e6;
    color: #fa8c16;
}

.reply_time {
    font-size: 13px;
    color: #999;
}

.reply_content {
    font-size: 15px;
    line-height: 1.6;
    color: #666;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.no_replies {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 14px;
}

/* å›å¤è¡¨å• */
.reply_form_section {
    padding: 20px;
    background: #f9fafb;
    border-radius: 6px;
    border: 1px solid #e8eaed;
}

.form_title {
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

#reply-content {
    width: 100%;
    padding: 12px;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

#reply-content:focus {
    outline: none;
    border-color: #003d79;
    box-shadow: 0 0 0 3px rgba(0,61,121,0.1);
}

.form_footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
}

.char_count {
    font-size: 12px;
    color: #999;
}

.btn_submit_reply {
    padding: 10px 24px;
    background: #003d79;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn_submit_reply:hover:not(:disabled) {
    background: #0056b3;
}

.btn_submit_reply:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* é€šçŸ¥æ ·å¼ */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10001;
    min-width: 250px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    font-size: 14px;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    background: #52c41a;
    color: #fff;
}

.notification-error {
    background: #f5222d;
    color: #fff;
}

.notification-warning {
    background: #faad14;
    color: #fff;
}

.notification-info {
    background: #1890ff;
    color: #fff;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1024px) {
    .detail_container {
        width: 95%;
    }
}
</style>

</body>
</html>
