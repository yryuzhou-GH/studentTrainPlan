<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="../static/css/style1.css" rel="stylesheet" type="text/css" />
    <link rel="icon" href="../static/images/logo.ico" type="image/x-icon"/>
<script src="{{ url_for('static', filename="js/jquery1.42.min.js") }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename="js/jquery.js") }}"></script>
<script src="{{ url_for('static', filename="js/jquery.superslide.2.1.1.js") }}" type="text/javascript"></script>
<title>首页</title>
</head>

<body>
<div class="wapper_box">
<div class="header_box"></div>
<div class="header_box1">
    <div class="header_box2">
         <a class="logo_box" href="{{ url_for('index') }}"><img src="{{ url_for('static', filename="images/logo1.jpg") }}"/></a>
         <ul class="nav_box">
             <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">个人中心</a></li>
             <!--251201，用户中心建设完成-->
             <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">消息中心</a></li>
             <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">课程论坛</a>
               <div class="nav_slide">
                <div class="nav_slide1">
                    <a href="{{ url_for('news_center') }}">课程公告<span><img src="../static/images/siade_bg1.png"/></span></a>
                    <a href="{{ url_for('course_discussion') }}">课程讨论<span><img src="../static/images/siade_bg1.png"/></span></a>
                 </div>
               </div>
             </li>
             <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">课程推荐</a></li>
             <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">选课中心</a></li>
             <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">课程进度</a></li>
             <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">首页</a></li>
         </ul>
    </div>
        <script>
             $(".nav_1").mouseenter(function(){
				 $(this).find(".nav_slide").slideDown()
			  });

			  $(".nav_1").mouseleave(function(){
				 $(".nav_slide").slideUp()
			 });
			 //$(".producys_box").mouseout(function(){
				// $(this).find(".producys_box1").slideUp();
			 //});
          </script>
</div>
<!--banner部分开始 - 优化：减小高度 -->
  <div class="banner_box" style="height: 150px;">
        <ul class="banner_pic">
            <li><img src="../static/images/logo.jpeg" /></li>
            <li><img src="../static/images/logo.jpeg" /></li>
            <li><img src="../static/images/logo.jpeg" /></li>

        </ul>
        <a class="prev" href="javascript:void(0)"></a>
        <a class="next" href="javascript:void(0)"></a>
        <div class="num"><ul></ul></div>
  </div>
	<script>
    /*鼠标移过，左右按钮显示*/
    $(".banner_box").hover(function(){
        $(this).find(".prev,.next").fadeTo("show",0.1);
    },function(){
        $(this).find(".prev,.next").hide();
    })
    /*鼠标移过某个按钮 高亮显示*/
    $(".prev,.next").hover(function(){
        $(this).fadeTo("show",0.7);
    },function(){
        $(this).fadeTo("show",0.1);
    })
    $(".banner_box").slide({ titCell:".num ul" , mainCell:".banner_pic" , effect:"fold", autoPlay:true, delayTime:700 , autoPage:true });
    </script>
    <!-- 代码 结束 -->
  <!--banner部分结束-->

<!--内容开始-->
<div class="content_box">
   <ul class="content_box_top">
      <li>
        <a href="{{ url_for('train_plan') }}"  onclick="get_info()" >  <img src="../static/images/icon11.png"/></a>
        <h3 class="obj_title" onclick="get_info()" >课程进度</h3>
      </li>
      <li>
        <a href="{{ url_for('recommed') }}"><img src="../static/images/icon21.png"/></a>
        <h3 class="obj_title">选课推荐</h3>
      </li>
      <li>
        <a href="{{ url_for('course_discussion') }}"><img src="../static/images/icon31.png"/></a>
        <h3 class="obj_title">课程讨论</h3>
      </li>
      <li>
        <a href="{{ url_for('personal_information') }}"><img src="../static/images/icon41.png"/></a>
        <h3 class="obj_title">个人中心</h3>
      </li>
   </ul>
</div>

<!-- 学生当前学习状态和课程进度展示区域 -->
<div class="status_progress_container">
    <!-- 左侧：学生当前学习状态 -->
    <div class="student_status_box">
        <h2 class="section_title">当前学习状态</h2>
        <div id="student-status-content" class="status_content">
            <div class="loading">加载中...</div>
        </div>
    </div>
    
    <!-- 右侧：课程进度 -->
    <div class="course_progress_box">
        <h2 class="section_title">课程进度</h2>
        <div id="course-progress-content" class="progress_content">
            <div class="loading">加载中...</div>
        </div>
    </div>
</div>

<!--内容结束-->

<!-- 以下是杰哥的新增内容 -->

<!-- 右侧固定按钮 -->
<div id="right-fixed-btn">小助手</div>

<!-- 悬浮窗（初始隐藏） -->
<div id="popup-mask"></div>
<div id="popup-window">
    <div id="popup-close">×</div>
    <div class="popup-content">
    <h3>ai课程学习助手</h3>
    <div id="ai-chat">
        <div id="chat-messages"></div>

        <div id="chat-input-area">
            <input id="chat-input" type="text" placeholder="请输入内容..." />
            <button id="chat-send-btn">发送</button>
        </div>
    </div>

</div>
</div>

<script>
$(function () {
    // 点击右侧按钮显示悬浮窗
    $("#right-fixed-btn").click(function () {
        $("#popup-window").fadeIn(200);
        $("#popup-mask").fadeIn(200);
    });

    // 点击关闭按钮隐藏
    $("#popup-close").click(function () {
        $("#popup-window").fadeOut(200);
        $("#popup-mask").fadeOut(200);
    });

    // 点击空白处关闭
    $("#popup-mask").click(function () {
        $("#popup-window").fadeOut(200);
        $("#popup-mask").fadeOut(200);
    });
});
</script>

<script>
$(function() {

    // 发送消息
    $("#chat-send-btn").click(function () {
        sendMessage();
    });

    // 回车发送
    $("#chat-input").keypress(function(e) {
        if (e.which == 13) {
            sendMessage();
        }
    });

    function sendMessage() {
        let text = $("#chat-input").val().trim();
        if (!text) return;

        // 显示用户消息
        $("#chat-messages").append(`
            <div class="msg user-msg">${text}</div>
        `);
        $("#chat-input").val("");
        scrollToBottom();

        // 请求后端
        $.ajax({
            url: "/api/deepseek_chat",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ message: text }),
            success: function(res) {
                if (res.reply) {
                    $("#chat-messages").append(`
                        <div class="msg bot-msg">${res.reply}</div>
                    `);
                } else if (res.error) {
                    $("#chat-messages").append(`
                        <div class="msg bot-msg error-msg">错误：${res.error}</div>
                    `);
                } else {
                    $("#chat-messages").append(`
                        <div class="msg bot-msg error-msg">未知错误，请稍后再试。</div>
                    `);
                }
                scrollToBottom();
            },
            error: function(xhr, status, error) {
                var errorMsg = "请求失败，请稍后再试。";
                
                // 尝试从响应中获取错误信息
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = "错误：" + xhr.responseJSON.error;
                } else if (xhr.status === 500) {
                    errorMsg = "服务器错误：可能是API密钥未配置或网络连接问题。";
                } else if (xhr.status === 400) {
                    errorMsg = "请求参数错误。";
                } else if (xhr.status === 0) {
                    errorMsg = "网络连接失败，请检查网络设置。";
                }
                
                $("#chat-messages").append(`
                    <div class="msg bot-msg error-msg">${errorMsg}</div>
                `);
                scrollToBottom();
            }
        });
    }

    function scrollToBottom() {
        let box = document.getElementById("chat-messages");
        box.scrollTop = box.scrollHeight;
    }
    
    // 加载学生当前学习状态
    function loadStudentStatus() {
        $.ajax({
            url: "/api/get_student_status",
            type: "GET",
            success: function(res) {
                if (res.success && res.data) {
                    let data = res.data;
                    let html = `
                        <div class="status_info_item">
                            <div class="info_label">姓名：</div>
                            <div class="info_value">${data.name || '未知'}</div>
                        </div>
                        <div class="status_info_item">
                            <div class="info_label">学院：</div>
                            <div class="info_value">${data.college || '未知'}</div>
                        </div>
                        <div class="status_info_item">
                            <div class="info_label">专业：</div>
                            <div class="info_value">${data.major || '未知'}</div>
                        </div>
                        <div class="status_info_item">
                            <div class="info_label">入学年份：</div>
                            <div class="info_value">${data.ad_year || '未知'}</div>
                        </div>
                        <div class="status_stat_box">
                            <div class="stat_item">
                                <div class="stat_number">${data.course_count || 0}</div>
                                <div class="stat_label">已选课程</div>
                            </div>
                            <div class="stat_item">
                                <div class="stat_number">${data.total_credits || 0}</div>
                                <div class="stat_label">总学分</div>
                            </div>
                        </div>
                        <div class="recent_courses">
                            <h4>最近课程</h4>
                            <ul class="course_list">
                    `;
                    
                    if (data.recent_courses && data.recent_courses.length > 0) {
                        data.recent_courses.slice(0, 5).forEach(function(course) {
                            html += `
                                <li class="course_item">
                                    <span class="course_name">${course.co_name}</span>
                                    <span class="course_credits">${course.credits}学分</span>
                                </li>
                            `;
                        });
                    } else {
                        html += '<li class="course_item">暂无课程记录</li>';
                    }
                    
                    html += `
                            </ul>
                        </div>
                    `;
                    
                    $("#student-status-content").html(html);
                } else {
                    $("#student-status-content").html('<div class="error">加载失败，请刷新重试</div>');
                }
            },
            error: function() {
                $("#student-status-content").html('<div class="error">加载失败，请刷新重试</div>');
            }
        });
    }
    
    // 加载课程进度（同步课程进度页的明细/汇总）
    function loadCourseProgress() {
        $("#course-progress-content").html('<div class="loading">加载中...</div>');
        $.ajax({
            url: "/api/get_course_progress_detail",
            type: "GET",
            success: function(res) {
                if (res.success && res.data) {
                    var summary = res.data.summary || {};
                    var courses = res.data.courses || [];

                    var html = '';
                    // 汇总卡片
                    html += `
                        <div class="summary_mini">
                            <div class="summary_mini_item">
                                <div class="summary_mini_label">课程总数</div>
                                <div class="summary_mini_value">${summary.total_courses || 0}</div>
                            </div>
                            <div class="summary_mini_item">
                                <div class="summary_mini_label">已完成</div>
                                <div class="summary_mini_value">${summary.completed || 0}</div>
                            </div>
                            <div class="summary_mini_item">
                                <div class="summary_mini_label">进行中</div>
                                <div class="summary_mini_value">${summary.in_progress || 0}</div>
                            </div>
                            <div class="summary_mini_item">
                                <div class="summary_mini_label">待开始</div>
                                <div class="summary_mini_value">${summary.pending || 0}</div>
                            </div>
                        </div>
                    `;

                    // 课程列表（取前5门）
                    if (!courses || courses.length === 0) {
                        html += '<div class="empty_state">暂无进度数据</div>';
                    } else {
                        courses.slice(0, 5).forEach(function(course) {
                            var statusClass = 'status_' + course.status;
                            var warningBadge = course.near_due && course.status !== 'completed'
                                ? '<span class="badge_warning">临近截止</span>' : '';
                            html += `
                                <div class="progress_item">
                                    <div class="progress_header">
                                        <span class="progress_name">${course.co_name}</span>
                                        <span class="progress_percentage">${course.progress}%</span>
                                    </div>
                                    <div class="progress_bar_container">
                                        <div class="progress_bar" style="width: ${course.progress}%;"></div>
                                    </div>
                                    <div class="progress_info">
                                        周次：${course.current_week} / ${course.total_weeks}　|　${course.recent_content}
                                    </div>
                                    <div class="course_status_line">
                                        <span class="status_badge ${statusClass}">${course.status_text}</span>
                                        ${warningBadge}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    $("#course-progress-content").html(html);
                } else {
                    $("#course-progress-content").html('<div class="error">加载失败，请刷新重试</div>');
                }
            },
            error: function() {
                $("#course-progress-content").html('<div class="error">加载失败，请刷新重试</div>');
            }
        });
    }
    
    // 页面加载时获取数据
    loadStudentStatus();
    loadCourseProgress();
});
</script>


<style>
/* 右侧按钮 */
#right-fixed-btn {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 60px;
    height: 60px;
    background: #3498db;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 9999;
    font-size: 14px;
}

/* 遮罩层 */
#popup-mask {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 9998;
}

/* 悬浮窗 */
#popup-window {
    position: fixed;
    top: 50%;
    left: 12.5%;
    transform: translateY(-50%);
    width: 75%;
    height: 75%;
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    display: none;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* 关闭按钮 */
#popup-close {
    position: absolute;
    right: 10px;
    top: 5px;
    cursor: pointer;
    font-size: 20px;
}

/* ai对话 */

/* ai chat 区域布局 */
#ai-chat {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* 消息显示区 */
#chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #dcdcdc;
    border-radius: 6px;
    background: #fafafa;
}

/* 单条消息 */
.msg {
    max-width: 70%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 10px;
    line-height: 1.4;
    font-size: 14px;
}

/* 用户消息（右对齐） */
.user-msg {
    background: #409eff;
    color: #fff;
    margin-left: auto;
}

/* AI 消息（左对齐） */
.bot-msg {
    background: #e4e7ed;
    color: #333;
    margin-right: auto;
}

/* 错误消息样式 */
.error-msg {
    background: #fee;
    color: #c33;
    border: 1px solid #fcc;
    margin-right: auto;
}

/* 输入框区域 */
#chat-input-area {
    display: flex;
    margin-top: 10px;
    gap: 10px;
}

#chat-input {
    flex: 1;
    height: 38px;
    border-radius: 6px;
    border: 1px solid #ccc;
    padding: 0 10px;
    font-size: 14px;
}

#chat-send-btn {
    width: 70px;
    background: #3498db;
    border: none;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
}

#chat-send-btn:hover {
    background: #2980b9;
}

/* 覆盖后的样式 */
/* 让 popup-content 允许内部 flex 完整伸展 */
.popup-content {
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* 让 ai-chat 能够填满剩余高度 */
#ai-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* 关键：允许子元素缩小，否则 overflow 不会生效 */
}

/* 聊天记录框：固定高度 + 滚动条 */
#chat-messages {
    flex: 1;
    min-height: 0; /* 关键：让 flex 子容器可以被压缩 */
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #dcdcdc;
    border-radius: 6px;
    background: #fafafa;
}

/* 输入区域固定在底部 */
#chat-input-area {
    flex-shrink: 0; /* 不被挤压 */
    display: flex;
    margin-top: 10px;
    gap: 10px;
}

/* 学生状态和课程进度容器 */
.status_progress_container {
    width: 1200px;
    margin: 30px auto;
    display: flex;
    gap: 20px;
    justify-content: space-between;
}

/* 学生状态框 */
.student_status_box, .course_progress_box {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section_title {
    font-size: 20px;
    color: #003d79;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #003d79;
}

/* 状态内容 */
.status_content, .progress_content {
    min-height: 200px;
}

.loading, .error {
    text-align: center;
    padding: 40px 0;
    color: #999;
}

.error {
    color: #f56c6c;
}

/* 状态信息项 */
.status_info_item {
    display: flex;
    margin-bottom: 15px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info_label {
    width: 100px;
    color: #666;
    font-weight: 500;
}

.info_value {
    flex: 1;
    color: #333;
}

/* 统计数字框 */
.status_stat_box {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: #f5f7fa;
    border-radius: 6px;
}

.stat_item {
    flex: 1;
    text-align: center;
}

.stat_number {
    font-size: 32px;
    font-weight: bold;
    color: #003d79;
    margin-bottom: 5px;
}

.stat_label {
    font-size: 14px;
    color: #666;
}

/* 最近课程 */
.recent_courses {
    margin-top: 20px;
}

.recent_courses h4 {
    font-size: 16px;
    color: #333;
    margin-bottom: 10px;
}

.course_list {
    list-style: none;
    padding: 0;
}

.course_item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background: #f9f9f9;
    border-radius: 4px;
    border-left: 3px solid #003d79;
}

.course_name {
    flex: 1;
    color: #333;
    font-size: 14px;
}

.course_credits {
    color: #666;
    font-size: 12px;
}

/* 进度项 */
.progress_item {
    margin-bottom: 20px;
}

.progress_item.total_progress {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e0e0e0;
}

.progress_header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.progress_name {
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

.progress_percentage {
    font-size: 14px;
    color: #003d79;
    font-weight: bold;
}

.progress_bar_container {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 5px;
}

.progress_bar {
    height: 100%;
    background: linear-gradient(90deg, #003d79, #409eff);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress_info {
    font-size: 12px;
    color: #666;
    text-align: right;
}

/* 首页课程进度汇总小卡 */
.summary_mini {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 16px;
}
.summary_mini_item {
    background: #f5f7fa;
    border-radius: 6px;
    padding: 10px 12px;
    border-left: 4px solid #003d79;
}
.summary_mini_label {
    font-size: 12px;
    color: #666;
}
.summary_mini_value {
    font-size: 18px;
    font-weight: 700;
    color: #003d79;
}
.course_status_line {
    margin-top: 6px;
    display: flex;
    gap: 8px;
    align-items: center;
}

.badge_warning {
    padding: 3px 8px;
    background: #fff1f0;
    color: #f5222d;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
}

/* 响应式设计 */
@media (max-width: 1280px) {
    .status_progress_container {
        width: 95%;
        flex-direction: column;
    }
    
    .student_status_box, .course_progress_box {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .status_progress_container {
        width: 100%;
        padding: 0 10px;
    }
    
    .status_stat_box {
        flex-direction: column;
        gap: 10px;
    }
    
    .stat_item {
        padding: 10px;
    }
}


</style>

</div>


</body>

</html>
