<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
<link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
<script src="{{ url_for('static', filename='js/jquery1.42.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
<title>发布话题</title>
</head>

<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/logo1.jpg') }}"/></a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">个人中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">消息中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">课程论坛</a>
                    <div class="nav_slide">
                        <div class="nav_slide1">
                            <a href="{{ url_for('news_center') }}">课程讨论<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
                            <a href="{{ url_for('course_discussion') }}">发布话题<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
                        </div>
                    </div>
                </li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">课程推荐</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">选课中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">课程进度</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">首页</a></li>
            </ul>
        </div>
        <script>
            $(".nav_1").mouseenter(function(){
                $(this).find(".nav_slide").slideDown()
            });
            $(".nav_1").mouseleave(function(){
                $(".nav_slide").slideUp()
            });
        </script>
    </div>

    <!-- 发布话题主体内容 -->
    <div class="publish_container">
        <div class="publish_card">
            <div class="card_header">
                <h2 class="card_title">发布新话题</h2>
                <a href="{{ url_for('news_center') }}" class="back_link">← 返回论坛</a>
            </div>
            <div class="card_body">
                <form id="publish-topic-form">
                    <div class="form_group">
                        <label for="topic-title">话题标题 <span class="required">*</span></label>
                        <input type="text" id="topic-title" name="topic" placeholder="请输入话题标题" required maxlength="100" />
                        <small class="form_hint">标题应简洁明了，能准确描述讨论内容</small>
                    </div>
                    <div class="form_group">
                        <label for="topic-content">话题内容 <span class="required">*</span></label>
                        <textarea id="topic-content" name="comments" placeholder="请输入话题内容，支持多行输入..." required rows="12"></textarea>
                        <div class="char_count">
                            <span id="char-count">0</span> / 2000 字
                        </div>
                    </div>
                    <div class="form_actions">
                        <button type="button" class="btn_cancel" id="cancel-btn">取消</button>
                        <button type="submit" class="btn_submit" id="submit-btn">发布话题</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(function() {
    // 字符计数
    $("#topic-content").on("input", function() {
        var length = $(this).val().length;
        $("#char-count").text(length);
        
        if (length > 2000) {
            $(this).val($(this).val().substring(0, 2000));
            $("#char-count").text(2000);
            showNotification("内容不能超过2000字", "warning");
        }
    });
    
    // 取消按钮
    $("#cancel-btn").click(function() {
        if (confirm("确定要取消发布吗？未保存的内容将丢失。")) {
            window.location.href = "{{ url_for('news_center') }}";
        }
    });
    
    // 表单提交
    $("#publish-topic-form").submit(function(e) {
        e.preventDefault();
        
        var topic = $("#topic-title").val().trim();
        var content = $("#topic-content").val().trim();
        
        // 验证
        if (!topic) {
            showNotification("请输入话题标题", "error");
            $("#topic-title").focus();
            return;
        }
        
        if (topic.length > 100) {
            showNotification("话题标题不能超过100字", "error");
            $("#topic-title").focus();
            return;
        }
        
        if (!content) {
            showNotification("请输入话题内容", "error");
            $("#topic-content").focus();
            return;
        }
        
        if (content.length < 10) {
            showNotification("话题内容至少需要10个字", "error");
            $("#topic-content").focus();
            return;
        }
        
        // 显示加载状态
        var submitBtn = $("#submit-btn");
        submitBtn.prop("disabled", true).text("发布中...");
        
        // 提交表单（使用JSON格式）
        $.ajax({
            url: "{{ url_for('course_discussion') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                topic: topic,
                comments: content
            }),
            success: function(response) {
                if (response.success) {
                    showNotification(response.message || "话题发布成功！", "success");
                    // 延迟跳转，让用户看到成功提示
                    setTimeout(function() {
                        window.location.href = "{{ url_for('news_center') }}";
                    }, 1500);
                } else {
                    showNotification(response.message || "发布失败，请稍后重试", "error");
                    submitBtn.prop("disabled", false).text("发布话题");
                }
            },
            error: function(xhr) {
                var errorMsg = "发布失败，请稍后重试";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        var error = JSON.parse(xhr.responseText);
                        if (error.message) {
                            errorMsg = error.message;
                        }
                    } catch(e) {
                        // 如果不是JSON，使用默认错误信息
                        if (xhr.status === 401) {
                            errorMsg = "用户未登录，请先登录";
                        } else if (xhr.status === 400) {
                            errorMsg = "请求参数错误";
                        }
                    }
                }
                showNotification(errorMsg, "error");
                submitBtn.prop("disabled", false).text("发布话题");
            }
        });
    });
    
    // 显示通知函数
    function showNotification(message, type) {
        type = type || "info";
        var notification = $('<div class="notification notification-' + type + '">' + message + '</div>');
        $("body").append(notification);
        
        setTimeout(function() {
            notification.addClass("show");
        }, 10);
        
        setTimeout(function() {
            notification.removeClass("show");
            setTimeout(function() {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    // 页面离开前提示
    var formChanged = false;
    $("#topic-title, #topic-content").on("input", function() {
        formChanged = true;
    });
    
    window.addEventListener("beforeunload", function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = "您有未保存的内容，确定要离开吗？";
        }
    });
});
</script>

<style>
/* 发布话题容器 */
.publish_container {
    width: 900px;
    margin: 30px auto;
    min-height: 600px;
}

.publish_card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}

.card_header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #f0f0f0;
    background: linear-gradient(135deg, #003d79 0%, #0056b3 100%);
}

.card_title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #fff;
}

.back_link {
    color: #fff;
    text-decoration: none;
    font-size: 14px;
    opacity: 0.9;
    transition: opacity 0.3s;
}

.back_link:hover {
    opacity: 1;
    text-decoration: underline;
}

.card_body {
    padding: 30px;
}

.form_group {
    margin-bottom: 24px;
}

.form_group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.required {
    color: #f5222d;
}

.form_group input[type="text"],
.form_group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
    transition: border-color 0.3s;
    box-sizing: border-box;
}

.form_group input[type="text"]:focus,
.form_group textarea:focus {
    outline: none;
    border-color: #003d79;
    box-shadow: 0 0 0 3px rgba(0,61,121,0.1);
}

.form_group textarea {
    resize: vertical;
    min-height: 200px;
    line-height: 1.6;
}

.form_hint {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #999;
}

.char_count {
    text-align: right;
    margin-top: 5px;
    font-size: 12px;
    color: #999;
}

.form_actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
}

.btn_cancel, .btn_submit {
    padding: 10px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn_cancel {
    background: #f5f7fa;
    color: #666;
}

.btn_cancel:hover {
    background: #e8eaed;
}

.btn_submit {
    background: #003d79;
    color: #fff;
}

.btn_submit:hover:not(:disabled) {
    background: #0056b3;
}

.btn_submit:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* 通知样式 */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10001;
    min-width: 250px;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    font-size: 14px;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    background: #52c41a;
    color: #fff;
}

.notification-error {
    background: #f5222d;
    color: #fff;
}

.notification-warning {
    background: #faad14;
    color: #fff;
}

.notification-info {
    background: #1890ff;
    color: #fff;
}

/* 响应式设计 */
@media (max-width: 1024px) {
    .publish_container {
        width: 95%;
    }
}
</style>

</body>
</html>
