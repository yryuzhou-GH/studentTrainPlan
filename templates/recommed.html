<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
    <script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}" type="text/javascript"></script>
    <title>课程推荐</title>
</head>
<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='images/logo1.jpg') }}"/></a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">个人中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">消息中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">课程论坛</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">课程推荐</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">选课中心</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">课程进度</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">首页</a></li>
            </ul>
        </div>
        <script>
            $(".nav_1").mouseenter(function(){ $(this).find(".nav_slide").slideDown() });
            $(".nav_1").mouseleave(function(){ $(".nav_slide").slideUp() });
        </script>
    </div>
</div>

<!-- 推荐主体 -->
<div class="recommend_container">
    <div class="page_header">
        <div>
            <h1 class="page_title">课程推荐</h1>
            <p class="page_subtitle">相似度分析 → 推荐结论 → 学习决策</p>
        </div>
        <div class="header_actions">
            <button class="btn_refresh" id="refresh-btn">刷新推荐</button>
            <span id="status-text" class="status_text">正在加载...</span>
        </div>
    </div>

    <!-- 顶部推荐依据可视化 -->
    <div class="analysis_section">
        <div class="analysis_card">
            <div class="card_header">
                <h2 class="card_title">课程相似度分析</h2>
            </div>
            <div id="course_chart" class="chart_box"></div>
            <div class="analysis_desc">
                基于已选课程、专业背景、学习方向等特征，计算待推荐课程与您的学习画像相似度。
            </div>
        </div>
        <div class="analysis_card">
            <div class="card_header">
                <h2 class="card_title">学习画像相似度</h2>
            </div>
            <div id="persona_chart" class="chart_box"></div>
            <div class="analysis_desc">
                综合课程选择、专业方向、兴趣标签，找到与您学习路径相近的匿名画像群体。
            </div>
        </div>
    </div>

    <!-- 课程推荐结果 -->
    <div class="results_section">
        <div class="section_header">
            <h2 class="section_title">推荐课程</h2>
            <a class="btn_link" href="{{ url_for('course_selection') }}">前往选课中心</a>
        </div>
        <div id="course-list" class="course_list_cards">
            <div class="loading">加载中...</div>
        </div>
    </div>

    <!-- 志同道合学习参考 -->
    <div class="persona_section">
        <div class="section_header">
            <h2 class="section_title">志同道合学习画像分析</h2>
        </div>
        <div id="persona-list" class="persona_list">
            <div class="loading">加载中...</div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="message" class="message_toast"></div>

<style>
.recommend_container { width: 1200px; margin: 30px auto; padding: 0 20px 40px 20px; }
.page_header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.page_title { margin: 0; font-size: 24px; font-weight: 600; color: #003d79; }
.page_subtitle { margin: 0; font-size: 14px; color: #666; }
.header_actions { margin-left: auto; display: flex; align-items: center; gap: 10px; }
.btn_refresh { padding: 8px 14px; border: 1px solid #003d79; background: #003d79; color: #fff; border-radius: 4px; cursor: pointer; font-size: 13px; }
.btn_refresh:hover { background: #0056b3; }
.status_text { font-size: 13px; color: #999; }

.analysis_section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
.analysis_card { background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
.card_header { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; }
.card_title { margin: 0; font-size: 16px; font-weight: 600; color: #333; }
.chart_box { width: 100%; height: 360px; }
.analysis_desc { padding: 10px 16px 14px 16px; font-size: 13px; color: #666; background: #f8f9fb; }

.results_section, .persona_section { background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 18px; margin-bottom: 18px; }
.section_header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 10px; border-bottom: 2px solid #003d79; margin-bottom: 12px; }
.section_title { margin: 0; font-size: 18px; font-weight: 600; color: #333; }
.btn_link { color: #003d79; text-decoration: none; font-size: 13px; padding: 6px 12px; border: 1px solid #003d79; border-radius: 4px; transition: all 0.2s; }
.btn_link:hover { background: #003d79; color: #fff; }

.course_list_cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
.course_card { border: 1px solid #f0f0f0; border-radius: 8px; padding: 14px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; }
.course_title_row { display: flex; justify-content: space-between; gap: 10px; align-items: center; }
.course_name { font-size: 15px; font-weight: 600; color: #333; }
.course_score { font-size: 14px; color: #003d79; font-weight: 600; }
.course_meta { font-size: 13px; color: #666; display: flex; gap: 12px; flex-wrap: wrap; }
.tag_list { display: flex; gap: 6px; flex-wrap: wrap; }
.tag { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 500; background: #e6f7ff; color: #1890ff; }
.tag_warn { background: #fff7e6; color: #fa8c16; }
.tag_match { background: #f6ffed; color: #52c41a; }
.card_actions { display: flex; gap: 10px; }
.btn_action { padding: 6px 12px; border: 1px solid #003d79; color: #003d79; background: #fff; border-radius: 4px; font-size: 13px; text-decoration: none; }
.btn_action:hover { background: #003d79; color: #fff; }

.persona_list { display: flex; flex-direction: column; gap: 10px; }
.persona_card { border: 1px solid #f0f0f0; border-radius: 8px; padding: 12px 14px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
.persona_title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 6px; }
.persona_desc { font-size: 13px; color: #666; line-height: 1.5; }
.tag_dir { background: #f0f5ff; color: #2f54eb; }

.loading, .error, .empty_state { text-align: center; padding: 30px 10px; color: #999; font-size: 14px; }
.error { color: #f56c6c; }

.message_toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; min-width: 240px; display: none; font-size: 14px; }
.message_toast.success { background: #52c41a; color: #fff; }
.message_toast.error { background: #f5222d; color: #fff; }

@media (max-width: 1200px) {
    .recommend_container { width: 95%; }
    .analysis_section { grid-template-columns: 1fr; }
    .chart_box { height: 320px; }
}
</style>

<script>
$(function() {
    var courseChart = echarts.init(document.getElementById('course_chart'));
    var personaChart = echarts.init(document.getElementById('persona_chart'));

    function showToast(text, success) {
        var el = $("#message");
        el.text(text || '');
        el.removeClass("success error").addClass(success ? "success" : "error");
        el.fadeIn(200);
        setTimeout(function(){ el.fadeOut(200); }, 3000);
    }

    function setLoading() {
        $("#status-text").text("正在加载...");
        $("#course-list").html('<div class="loading">加载中...</div>');
        $("#persona-list").html('<div class="loading">加载中...</div>');
        var loadingOption = { title: { text: '加载中...', left: 'center', top: 'middle', textStyle: { color: '#666', fontSize: 14 } } };
        courseChart.setOption(loadingOption, true);
        personaChart.setOption(loadingOption, true);
    }

    function renderCharts(courseSource, personSource) {
        // 课程相似度图（柱状）
        courseChart.setOption({
            dataset: { source: courseSource },
            grid: { containLabel: true },
            xAxis: { name: '相似度' },
            yAxis: { type: 'category' },
            visualMap: {
                orient: 'horizontal',
                left: 'center',
                min: 1,
                max: 5,
                text: ['高', '低'],
                dimension: 0,
                inRange: { color: ['#D7DA8B', '#E15457'] }
            },
            series: [{ type: 'bar', encode: { x: 'amount', y: 'product' } }]
        }, true);

        // 画像相似度图（柱状）
        personaChart.setOption({
            dataset: { source: personSource },
            grid: { containLabel: true },
            xAxis: { name: '相似度' },
            yAxis: { type: 'category' },
            visualMap: {
                orient: 'horizontal',
                left: 'center',
                min: 0,
                max: 1,
                text: ['高', '低'],
                dimension: 0,
                inRange: { color: ['#D7DA8B', '#E15457'] }
            },
            series: [{ type: 'bar', encode: { x: 'amount', y: 'product' } }]
        }, true);
    }

    function renderCourseCards(courseSource) {
        // 数据格式：source: [["amount","product"], [score, name], ...]
        if (!courseSource || courseSource.length <= 1) {
            $("#course-list").html('<div class="empty_state">暂无课程推荐数据</div>');
            return;
        }
        var rows = courseSource.slice(1).map(function(r) {
            return { score: r[0], name: r[1] };
        });
        rows.sort(function(a,b){ return b.score - a.score; });
        var html = '';
        rows.slice(0, 6).forEach(function(item, idx) {
            var tags = ['学习路径相似', '专业方向匹配', '课程选择高度相似'];
            var tagHtml = tags.slice(0, 2 + (idx % 2)).map(function(t,i){
                var cls = i === 0 ? 'tag_match' : (i === 1 ? 'tag' : 'tag_warn');
                return '<span class="tag ' + cls + '">' + t + '</span>';
            }).join('');
            html += `
                <div class="course_card">
                    <div class="course_title_row">
                        <span class="course_name">${item.name || '推荐课程'}</span>
                        <span class="course_score">${(item.score || 0).toFixed(2)}</span>
                    </div>
                    <div class="course_meta">
                        <span>授课教师：待定</span>
                        <span>学分：待定</span>
                        <span>推荐依据：相似度分析</span>
                    </div>
                    <div class="tag_list">${tagHtml}</div>
                    <div class="card_actions">
                        <a class="btn_action" href="/course_selection">前往选课中心</a>
                        <a class="btn_action" href="#" onclick="showToast('详情功能待接入课程平台', false);return false;">查看课程详情</a>
                    </div>
                </div>
            `;
        });
        $("#course-list").html(html);
    }

    function renderPersonaList(personSource) {
        if (!personSource || personSource.length <= 1) {
            $("#persona-list").html('<div class="empty_state">暂无画像相似度数据</div>');
            return;
        }
        var rows = personSource.slice(1).map(function(r){ return { score: r[0], name: r[1] }; });
        rows.sort(function(a,b){ return b.score - a.score; });
        var cnt = rows.length;
        var topScore = rows[0].score || 0;
        var avgScore = rows.reduce(function(s,r){ return s + (r.score || 0); }, 0) / cnt;
        var tags = ['专业方向匹配','课程选择相近','学习节奏相似','兴趣方向一致','学习路径相似'];
        var coursesDir = ['算法与编程','系统基础','数据与智能','工程实践','软件工程'];
        var tagHtml = tags.slice(0,3).map(function(t){ return '<span class="tag tag_match">' + t + '</span>'; }).join('');
        var dirHtml = coursesDir.slice(0,3).map(function(t){ return '<span class="tag tag_dir">' + t + '</span>'; }).join('');

        $("#persona-list").html(`
            <div class="persona_card">
                <div class="persona_title">画像相似度摘要</div>
                <div class="persona_desc">
                    找到 <b>${cnt}</b> 份相似学习画像，最高相似度 <b>${(topScore*100).toFixed(1)}%</b>，平均相似度 <b>${(avgScore*100).toFixed(1)}%</b>。
                </div>
                <div class="persona_desc">主要相似特征：${tagHtml}</div>
                <div class="persona_desc">常见课程方向：${dirHtml}</div>
            </div>
        `);
    }

    function loadData() {
        setLoading();
        $.ajax({
            url: '/getRecommedData',
            type: 'GET',
            dataType: 'json',
            success: function(res) {
                if (!res) {
                    $("#status-text").text("加载失败");
                    showToast("推荐数据为空", false);
                    return;
                }
                var course = res.course && res.course.source ? res.course.source : [];
                var person = res.person && res.person.source ? res.person.source : [];
                renderCharts(course, person);
                renderCourseCards(course);
                renderPersonaList(person);
                $("#status-text").text("加载完成");
            },
            error: function(xhr) {
                $("#status-text").text("加载失败");
                showToast("加载推荐数据失败", false);
                var err = { title: { text: '加载失败', subtext: '请刷新重试', left: 'center', top: 'middle', textStyle: { color: '#f56c6c' } } };
                courseChart.setOption(err, true);
                personaChart.setOption(err, true);
                $("#course-list").html('<div class="error">加载失败，请刷新重试</div>');
                $("#persona-list").html('<div class="error">加载失败，请刷新重试</div>');
            }
        });
    }

    $("#refresh-btn").click(function(){ loadData(); });
    loadData();
});
</script>

</body>
</html>