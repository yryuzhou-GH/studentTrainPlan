<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰è¯¾ä¸­å¿ƒ</title>
    <link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
    <link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
    <script src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}" type="text/javascript"></script>
</head>
<body>
    <div class="wapper_box">
        <div class="header_box"></div>
        <div class="header_box1">
            <div class="header_box2">
                <a class="logo_box" href="{{ url_for('index') }}">
                    <img src="{{ url_for('static', filename='images/logo1.jpg') }}"/>
                </a>
                <ul class="nav_box">
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">ä¸ªäººä¸­å¿ƒ</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">æ¶ˆæ¯ä¸­å¿ƒ</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">è¯¾ç¨‹è®ºå›</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">è¯¾ç¨‹æ¨è</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">é€‰è¯¾ä¸­å¿ƒ</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">è¯¾ç¨‹è¿›åº¦</a></li>
                    <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">é¦–é¡µ</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- é€‰è¯¾ä¸­å¿ƒä¸»ä½“å†…å®¹ -->
    <div class="selection_container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page_header">
            <h1 class="page_title">é€‰è¯¾ä¸­å¿ƒ</h1>
            <p class="page_subtitle">ä¸“ä¸šé€‰ä¿®è¯¾ç¨‹é€‰è¯¾ç³»ç»Ÿ</p>
        </div>

        <!-- é€‰è¯¾çŠ¶æ€æç¤ºåŒº -->
        <div class="status_summary_card">
            <div class="status_item">
                <div class="status_icon">ğŸ“š</div>
                <div class="status_content">
                    <div class="status_value" id="selected-count">{{ chosen_courses|length }}</div>
                    <div class="status_label">å·²é€‰è¯¾ç¨‹</div>
                </div>
            </div>
            <div class="status_item">
                <div class="status_icon">ğŸ“</div>
                <div class="status_content">
                    <div class="status_value" id="total-credits">0</div>
                    <div class="status_label">å·²ä¿®å­¦åˆ†</div>
                </div>
            </div>
            <div class="status_item status_warning" id="conflict-warning" style="display: none;">
                <div class="status_icon">âš ï¸</div>
                <div class="status_content">
                    <div class="status_value">æ—¶é—´å†²çª</div>
                    <div class="status_label" id="conflict-detail">æ£€æµ‹åˆ°è¯¾ç¨‹æ—¶é—´å†²çª</div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæœç´¢åŒºåŸŸ -->
        <div class="filter_card">
            <div class="filter_row">
                <div class="search_box">
                    <input type="text" id="search-keyword" class="search_input" placeholder="æœç´¢è¯¾ç¨‹åç§°æˆ–è¯¾ç¨‹ç¼–å·..." />
                    <button class="search_btn" id="search-btn">ğŸ” æœç´¢</button>
                </div>
            </div>
            
            <!-- è¯¾ç¨‹è¯¦æƒ…å¡ç‰‡ï¼ˆæœç´¢ç»“æœåªæœ‰1é—¨æ—¶æ˜¾ç¤ºï¼‰ -->
            <div id="course-detail-card" class="course_detail_card" style="display: none;">
                <div class="detail_card_header">
                    <h3 class="detail_card_title">è¯¾ç¨‹è¯¦æƒ…</h3>
                    <span class="detail_card_close" onclick="$('#course-detail-card').fadeOut(200);">&times;</span>
                </div>
                <div class="detail_card_body">
                    <div class="course_detail_info">
                        <div class="detail_row">
                            <div class="detail_label">è¯¾ç¨‹ç¼–å·ï¼š</div>
                            <div class="detail_value" id="detail-co-no">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">è¯¾ç¨‹åç§°ï¼š</div>
                            <div class="detail_value course_name" id="detail-co-name">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">è¯¾ç¨‹ç±»å‹ï¼š</div>
                            <div class="detail_value" id="detail-classification">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">å­¦åˆ†ï¼š</div>
                            <div class="detail_value" id="detail-credits">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">æˆè¯¾æ•™å¸ˆï¼š</div>
                            <div class="detail_value" id="detail-teacher">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">ä¸Šè¯¾æ—¶é—´ï¼š</div>
                            <div class="detail_value" id="detail-class-time">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">è¯¾ç¨‹å®¹é‡ï¼š</div>
                            <div class="detail_value" id="detail-capacity">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">å¼€è¯¾å­¦é™¢ï¼š</div>
                            <div class="detail_value" id="detail-college">-</div>
                        </div>
                        <div class="detail_row">
                            <div class="detail_label">è¯¾ç¨‹çŠ¶æ€ï¼š</div>
                            <div class="detail_value" id="detail-status">-</div>
                        </div>
                    </div>
                </div>
                <div class="detail_card_footer">
                    <button type="button" class="btn_cancel" onclick="$('#course-detail-card').fadeOut(200);">å…³é—­</button>
                    <button type="button" class="btn_submit" id="detail-select-btn" style="display: none;" onclick="selectCourseFromDetail();">ç«‹å³é€‰è¯¾</button>
                </div>
            </div>
            <div class="filter_row">
                <div class="filter_group">
                    <label class="filter_label">å­¦é™¢ï¼š</label>
                    <select id="filter-college" class="filter_select">
                        <option value="">å…¨éƒ¨å­¦é™¢</option>
                        <option value="æ™ºèƒ½ä¸è®¡ç®—å­¦éƒ¨" selected>æ™ºèƒ½ä¸è®¡ç®—å­¦éƒ¨</option>
                        {% if colleges %}
                        {% for college in colleges %}
                        {% if college != 'æ™ºèƒ½ä¸è®¡ç®—å­¦éƒ¨' %}
                        <option value="{{ college }}">{{ college }}</option>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="filter_group">
                    <label class="filter_label">è¯¾ç¨‹ç±»å‹ï¼š</label>
                    <select id="filter-course-type" class="filter_select">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="elective">ä¸“ä¸šé€‰ä¿®</option>
                        <option value="required">å¿…ä¿®</option>
                    </select>
                </div>
                <div class="filter_group">
                    <label class="filter_label">å­¦åˆ†èŒƒå›´ï¼š</label>
                    <input type="number" id="filter-credits-min" class="filter_input_small" placeholder="æœ€å°" min="0" step="0.5" />
                    <span class="filter_separator">-</span>
                    <input type="number" id="filter-credits-max" class="filter_input_small" placeholder="æœ€å¤§" min="0" step="0.5" />
                </div>
                <div class="filter_group">
                    <label class="filter_label">ä¸Šè¯¾æ—¶é—´ï¼š</label>
                    <select id="filter-class-time" class="filter_select">
                        <option value="">å…¨éƒ¨æ—¶é—´</option>
                        <option value="å‘¨ä¸€">å‘¨ä¸€</option>
                        <option value="å‘¨äºŒ">å‘¨äºŒ</option>
                        <option value="å‘¨ä¸‰">å‘¨ä¸‰</option>
                        <option value="å‘¨å››">å‘¨å››</option>
                        <option value="å‘¨äº”">å‘¨äº”</option>
                        <option value="å‘¨å…­">å‘¨å…­</option>
                        <option value="å‘¨æ—¥">å‘¨æ—¥</option>
                    </select>
                </div>
                <div class="filter_group">
                    <button class="btn_reset" id="reset-filters-btn">é‡ç½®</button>
                </div>
            </div>
        </div>

        <!-- å·²é€‰è¯¾ç¨‹åŒºåŸŸ -->
        <div class="courses_section">
            <div class="section_header">
                <h2 class="section_title">å·²é€‰è¯¾ç¨‹ <span class="course_count" id="chosen-count">({{ chosen_courses|length }})</span></h2>
            </div>
            <div class="courses_table_container">
                <table class="courses_table" id="chosen-courses-table">
                <thead>
                    <tr>
                        <th>è¯¾ç¨‹ç¼–å·</th>
                        <th>è¯¾ç¨‹åç§°</th>
                        <th>è¯¾ç¨‹ç±»å‹</th>
                        <th>å­¦åˆ†</th>
                        <th>ä»»è¯¾æ•™å¸ˆ</th>
                            <th>ä¸Šè¯¾æ—¶é—´</th>
                        <th>æˆç»©</th>
                        <th>è¯„ä»·</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                    <tbody id="chosen-courses-body">
                        {% if chosen_courses %}
                    {% for course in chosen_courses %}
                            <tr data-co-no="{{ course[0] }}">
                        <td>{{ course[0] }}</td>
                        <td>{{ course[1] }}</td>
                        <td>{{ course[2] }}</td>
                        <td>{{ course[5] }}</td>
                                <td>{{ course[6] if course[6] else 'å¾…å®š' }}</td>
                                <td class="class-time-cell">å¾…åŠ è½½</td>
                        <td>{{ course[3] if course[3] else 'æœªè¯„åˆ†' }}</td>
                        <td>{{ course[4] if course[4] else 'æœªè¯„ä»·' }}</td>
                        <td>
                                    <button class="btn_action btn_drop" onclick="dropCourse('{{ course[0] }}', '{{ course[1] }}')">
                                é€€é€‰
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="empty_cell">æ‚¨è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•è¯¾ç¨‹</td>
                            </tr>
                        {% endif %}
                </tbody>
            </table>
            </div>
        </div>

        <!-- å¯é€‰è¯¾ç¨‹åŒºåŸŸ -->
        <div class="courses_section">
            <div class="section_header">
                <h2 class="section_title">å¯é€‰è¯¾ç¨‹ <span class="course_count" id="available-count">({{ available_courses|length }})</span></h2>
            </div>
            <div class="courses_table_container">
                <table class="courses_table" id="available-courses-table">
                <thead>
                    <tr>
                        <th>è¯¾ç¨‹ç¼–å·</th>
                        <th>è¯¾ç¨‹åç§°</th>
                        <th>è¯¾ç¨‹ç±»å‹</th>
                        <th>å­¦åˆ†</th>
                        <th>ä»»è¯¾æ•™å¸ˆ</th>
                        <th>ä¸Šè¯¾æ—¶é—´</th>
                            <th>è¯¾ç¨‹å®¹é‡</th>
                        <th>å¼€è¯¾å­¦é™¢</th>
                            <th>è¯¾ç¨‹çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                    <tbody id="available-courses-body">
                        {% if available_courses %}
                    {% for course in available_courses %}
                            <tr data-co-no="{{ course[0] }}">
                        <td>{{ course[0] }}</td>
                        <td>{{ course[1] }}</td>
                        <td>{{ course[2] }}</td>
                        <td>{{ course[3] }}</td>
                                <td>{{ course[4] if course[4] and course[4] != 'æœªå®š' else 'å¾…å®š' }}</td>
                                <td>{{ course[8] if course[8] and course[8] != 'æœªå®š' else 'å¾…å®š' }}</td>
                                <td>
                                    {% if course[9] %}
                                        <span class="capacity_text">{{ course[9] }}äºº</span>
                                    {% else %}
                                        <span class="capacity_text">ä¸é™</span>
                                    {% endif %}
                                </td>
                                <td>{{ course[10] if course[10] else 'æœªçŸ¥' }}</td>
                                <td>
                                    <span class="status_badge status_available">å¯é€‰</span>
                                </td>
                                <td>
                                    <button class="btn_action btn_select" onclick="selectCourse('{{ course[0] }}', '{{ course[1] }}')">
                                é€‰è¯¾
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="10" class="empty_cell">æ²¡æœ‰å¯é€‰è¯¾ç¨‹</td>
                            </tr>
                        {% endif %}
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message_toast"></div>

    <script>
    $(function() {
        // åŠ è½½é€‰è¯¾ç»Ÿè®¡ä¿¡æ¯
        function loadStatistics() {
            $.ajax({
                url: "/api/get_selection_statistics",
                type: "GET",
                success: function(res) {
                    if (res.success && res.data) {
                        var data = res.data;
                        $("#total-credits").text(data.total_credits || 0);
                        
                        // æ˜¾ç¤ºæ—¶é—´å†²çªè­¦å‘Š
                        if (data.time_conflicts && data.time_conflicts.length > 0) {
                            var conflictText = "æ£€æµ‹åˆ° " + data.time_conflicts.length + " ä¸ªæ—¶é—´å†²çª";
                            $("#conflict-detail").text(conflictText);
                            $("#conflict-warning").show();
                        } else {
                            $("#conflict-warning").hide();
                        }
                    }
                },
                error: function() {
                    console.error("åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥");
                }
            });
        }

        // åŠ è½½å·²é€‰è¯¾ç¨‹çš„ä¸Šè¯¾æ—¶é—´
        function loadChosenCoursesDetails() {
            var coNos = [];
            $("#chosen-courses-body tr[data-co-no]").each(function() {
                coNos.push($(this).data("co-no"));
            });
            
            if (coNos.length === 0) return;
            
            // æ‰¹é‡æŸ¥è¯¢è¯¾ç¨‹è¯¦æƒ…
            $.ajax({
                url: "/api/get_filtered_courses",
                type: "GET",
                success: function(res) {
                    if (res.success && res.data) {
                        var coursesMap = {};
                        res.data.forEach(function(course) {
                            coursesMap[course.co_no] = course;
                        });
                        
                        // æ›´æ–°å·²é€‰è¯¾ç¨‹çš„ä¸Šè¯¾æ—¶é—´
                        $("#chosen-courses-body tr[data-co-no]").each(function() {
                            var coNo = $(this).data("co-no");
                            var course = coursesMap[coNo];
                            if (course) {
                                $(this).find(".class-time-cell").text(course.class_time || 'å¾…å®š');
                            }
                        });
                    }
                }
            });
        }

        // æœç´¢å’Œç­›é€‰åŠŸèƒ½
        function applyFilters() {
            var keyword = $("#search-keyword").val().trim();
            var college = $("#filter-college").val();
            var courseType = $("#filter-course-type").val();
            var creditsMin = $("#filter-credits-min").val();
            var creditsMax = $("#filter-credits-max").val();
            var classTime = $("#filter-class-time").val();
            
            console.log("[DEBUG] æœç´¢å‚æ•°:", {
                keyword: keyword,
                college: college,
                course_type: courseType,
                credits_min: creditsMin,
                credits_max: creditsMax,
                class_time: classTime
            });
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $("#available-courses-body").html('<tr><td colspan="10" class="loading_cell">åŠ è½½ä¸­...</td></tr>');
            
            $.ajax({
                url: "/api/get_filtered_courses",
                type: "GET",
                data: {
                    keyword: keyword,
                    college: college,
                    course_type: courseType,
                    credits_min: creditsMin,
                    credits_max: creditsMax,
                    class_time: classTime
                },
                success: function(res) {
                    console.log("[DEBUG] æœç´¢ç»“æœ:", res);
                    if (res.success && res.data) {
                        renderAvailableCourses(res.data);
                        // å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœæç¤º
                        if (keyword) {
                            var count = res.data.length;
                            if (count === 0) {
                                showMessage("æœªæ‰¾åˆ°åŒ¹é…çš„è¯¾ç¨‹", false);
                            } else if (count === 1) {
                                showMessage("æ‰¾åˆ° 1 é—¨è¯¾ç¨‹ï¼Œå·²è‡ªåŠ¨å¼¹å‡ºè¯¦æƒ…", true);
                            } else {
                                showMessage("æ‰¾åˆ° " + count + " é—¨è¯¾ç¨‹", true);
                            }
                        }
                    } else {
                        $("#available-courses-body").html('<tr><td colspan="10" class="empty_cell">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>');
                        showMessage("åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•", false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("[ERROR] æœç´¢å¤±è´¥:", {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error
                    });
                    $("#available-courses-body").html('<tr><td colspan="10" class="empty_cell">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</td></tr>');
                    var errorMsg = "æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
                    if (xhr.status === 401) {
                        errorMsg = "ç”¨æˆ·æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•";
                    }
                    showMessage(errorMsg, false);
                }
            });
        }

        // æ¸²æŸ“å¯é€‰è¯¾ç¨‹åˆ—è¡¨
        function renderAvailableCourses(courses) {
            if (courses.length === 0) {
                $("#available-courses-body").html('<tr><td colspan="10" class="empty_cell">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è¯¾ç¨‹</td></tr>');
                $("#available-count").text("(0)");
                // éšè—è¯¾ç¨‹è¯¦æƒ…å¡ç‰‡
                $("#course-detail-card").fadeOut(200);
                return;
            }
            
            // å¦‚æœåªæ‰¾åˆ°1é—¨è¯¾ç¨‹ï¼Œåœ¨æœç´¢æ¡†ä¸‹æ–¹æ˜¾ç¤ºè¯¾ç¨‹è¯¦æƒ…
            if (courses.length === 1) {
                showCourseDetailCard(courses[0]);
            } else {
                // å¤šé—¨è¯¾ç¨‹æ—¶éšè—è¯¦æƒ…å¡ç‰‡
                $("#course-detail-card").fadeOut(200);
            }
            
            var html = '';
            courses.forEach(function(course) {
                var capacityText = '';
                if (course.max_students > 0) {
                    capacityText = course.current_students + ' / ' + course.max_students;
                } else {
                    capacityText = 'ä¸é™';
                }
                
                var statusClass = 'status_' + course.status;
                var btnDisabled = course.status !== 'available' ? 'disabled' : '';
                var btnText = course.status === 'chosen' ? 'å·²é€‰' : (course.status === 'full' ? 'å·²æ»¡' : 'é€‰è¯¾');
                
                html += `
                    <tr data-co-no="${course.co_no}">
                        <td>${course.co_no}</td>
                        <td>${course.co_name}</td>
                        <td>${course.classification}</td>
                        <td>${course.credits}</td>
                        <td>${course.teacher}</td>
                        <td>${course.class_time || 'å¾…å®š'}</td>
                        <td>${capacityText}</td>
                        <td>${course.college}</td>
                        <td>
                            <span class="status_badge ${statusClass}">${course.status_text}</span>
                        </td>
                        <td>
                            <button class="btn_action btn_select" ${btnDisabled} onclick="selectCourse('${course.co_no}', '${course.co_name}')" ${btnDisabled ? 'disabled' : ''}>
                                ${btnText}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            $("#available-courses-body").html(html);
            $("#available-count").text("(" + courses.length + ")");
        }
        
        // æ˜¾ç¤ºè¯¾ç¨‹è¯¦æƒ…å¡ç‰‡ï¼ˆåœ¨æœç´¢æ¡†ä¸‹æ–¹ï¼‰
        function showCourseDetailCard(course) {
            var capacityText = '';
            if (course.max_students > 0) {
                capacityText = course.current_students + ' / ' + course.max_students + ' äºº';
            } else {
                capacityText = 'ä¸é™';
            }
            
            var statusClass = 'status_' + course.status;
            var statusText = course.status_text;
            var canSelect = course.status === 'available';
            
            // å¡«å……è¯¾ç¨‹è¯¦æƒ…ä¿¡æ¯
            $("#detail-co-no").text(course.co_no);
            $("#detail-co-name").text(course.co_name);
            $("#detail-classification").text(course.classification);
            $("#detail-credits").text(course.credits + ' å­¦åˆ†');
            $("#detail-teacher").text(course.teacher || 'å¾…å®š');
            $("#detail-class-time").text(course.class_time || 'å¾…å®š');
            $("#detail-capacity").text(capacityText);
            $("#detail-college").text(course.college || 'æœªçŸ¥');
            $("#detail-status").html('<span class="status_badge ' + statusClass + '">' + statusText + '</span>');
            
            // ä¿å­˜è¯¾ç¨‹ä¿¡æ¯åˆ°æŒ‰é’®ï¼Œç”¨äºé€‰è¯¾
            $("#detail-select-btn").data('co-no', course.co_no).data('co-name', course.co_name);
            
            // æ˜¾ç¤º/éšè—é€‰è¯¾æŒ‰é’®
            if (canSelect) {
                $("#detail-select-btn").show();
            } else {
                $("#detail-select-btn").hide();
            }
            
            // æ˜¾ç¤ºè¯¦æƒ…å¡ç‰‡
            $("#course-detail-card").fadeIn(200);
        }
        
        // ä»è¯¦æƒ…å¡ç‰‡é€‰è¯¾
        window.selectCourseFromDetail = function() {
            var coNo = $("#detail-select-btn").data('co-no');
            var coName = $("#detail-select-btn").data('co-name');
            if (coNo && coName) {
                selectCourse(coNo, coName);
            }
        };

        // æœç´¢æŒ‰é’®ç‚¹å‡»
        $("#search-btn").click(function(e) {
            e.preventDefault();
            applyFilters();
        });

        // å›è½¦æœç´¢
        $("#search-keyword").keypress(function(e) {
            if (e.which == 13) {
                e.preventDefault();
                applyFilters();
            }
        });
        
        // å®æ—¶æœç´¢ï¼ˆå¯é€‰ï¼šè¾“å…¥æ—¶å»¶è¿Ÿæœç´¢ï¼‰
        var searchTimeout;
        $("#search-keyword").on("input", function() {
            clearTimeout(searchTimeout);
            var keyword = $(this).val().trim();
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è¯¾ç¨‹
            if (keyword === '') {
                searchTimeout = setTimeout(function() {
                    applyFilters();
                }, 300);
            }
        });

        // ç­›é€‰æ¡ä»¶å˜åŒ–
        $("#filter-college, #filter-course-type, #filter-class-time").change(function() {
            applyFilters();
        });

        // å­¦åˆ†èŒƒå›´è¾“å…¥
        $("#filter-credits-min, #filter-credits-max").on("blur", function() {
            applyFilters();
        });

        // é‡ç½®ç­›é€‰
        $("#reset-filters-btn").click(function(e) {
            e.preventDefault();
            $("#search-keyword").val("");
            $("#filter-college").val("");
            $("#filter-course-type").val("");
            $("#filter-credits-min").val("");
            $("#filter-credits-max").val("");
            $("#filter-class-time").val("");
            applyFilters();
        });

        // é€‰è¯¾å‡½æ•°
        window.selectCourse = function(coNo, coName) {
            if (!confirm('ç¡®å®šè¦é€‰æ‹©è¯¾ç¨‹ã€Š' + coName + 'ã€‹å—ï¼Ÿ\n\næç¤ºï¼šé€‰è¯¾åï¼Œæ¨èç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„é€‰è¯¾ä¿¡æ¯åŠ¨æ€æ›´æ–°æ¨èç»“æœã€‚')) {
                return;
            }

            var btn = event.target;
            $(btn).prop("disabled", true).text("é€‰è¯¾ä¸­...");

            $.ajax({
                url: '/api/select_course',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ co_no: coNo }),
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message + ' æ¨èç³»ç»Ÿå·²è‡ªåŠ¨æ›´æ–°ï¼', true);
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage(response.message, false);
                        $(btn).prop("disabled", false).text("é€‰è¯¾");
                    }
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    showMessage(response ? response.message : 'é€‰è¯¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', false);
                    $(btn).prop("disabled", false).text("é€‰è¯¾");
                }
            });
        };

        // é€€è¯¾å‡½æ•°
        window.dropCourse = function(coNo, coName) {
            if (!confirm('ç¡®å®šè¦é€€é€‰è¯¾ç¨‹ã€Š' + coName + 'ã€‹å—ï¼Ÿ\n\næç¤ºï¼šé€€è¯¾åï¼Œæ¨èç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„é€‰è¯¾ä¿¡æ¯åŠ¨æ€æ›´æ–°æ¨èç»“æœã€‚')) {
                return;
            }

            var btn = event.target;
            $(btn).prop("disabled", true).text("é€€é€‰ä¸­...");

            $.ajax({
                url: '/api/drop_course',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ co_no: coNo }),
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message + ' æ¨èç³»ç»Ÿå·²è‡ªåŠ¨æ›´æ–°ï¼', true);
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        showMessage(response.message, false);
                        $(btn).prop("disabled", false).text("é€€é€‰");
                    }
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    showMessage(response ? response.message : 'é€€è¯¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', false);
                    $(btn).prop("disabled", false).text("é€€é€‰");
                }
            });
        };

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, isSuccess) {
            const messageDiv = $("#message");
            messageDiv.text(text);
            messageDiv.removeClass("success error").addClass(isSuccess ? "success" : "error");
            messageDiv.fadeIn(200);
            
            setTimeout(function() {
                messageDiv.fadeOut(200);
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadStatistics();
        loadChosenCoursesDetails();
    });
    </script>

    <style>
    /* é€‰è¯¾ä¸­å¿ƒå®¹å™¨ */
    .selection_container {
        width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
    }

    /* é¡µé¢æ ‡é¢˜ */
    .page_header {
        text-align: center;
        margin-bottom: 30px;
    }

    .page_title {
        font-size: 28px;
        font-weight: 600;
        color: #003d79;
        margin: 0 0 10px 0;
    }

    .page_subtitle {
        font-size: 16px;
        color: #666;
        margin: 0;
    }

    /* çŠ¶æ€æç¤ºå¡ç‰‡ */
    .status_summary_card {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .status_item {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
        border-radius: 6px;
        border-left: 4px solid #003d79;
    }

    .status_warning {
        border-left-color: #faad14;
        background: linear-gradient(135deg, #fff7e6 0%, #ffffff 100%);
    }

    .status_icon {
        font-size: 32px;
    }

    .status_content {
        flex: 1;
    }

    .status_value {
        font-size: 24px;
        font-weight: bold;
        color: #003d79;
        margin-bottom: 5px;
    }

    .status_label {
        font-size: 14px;
        color: #666;
    }

    /* ç­›é€‰å¡ç‰‡ */
    .filter_card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
    }

    .filter_row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter_row:first-child {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .search_box {
        flex: 1;
        display: flex;
        gap: 10px;
        min-width: 400px;
    }

    .search_input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .search_input:focus {
        outline: none;
        border-color: #003d79;
        box-shadow: 0 0 0 3px rgba(0,61,121,0.1);
    }

    .search_btn {
        padding: 10px 20px;
        background: #003d79;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
    }

    .search_btn:hover {
        background: #0056b3;
    }

    .filter_group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter_label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
        white-space: nowrap;
    }

    .filter_select {
        padding: 8px 12px;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        font-size: 14px;
        background: #fff;
        cursor: pointer;
        min-width: 120px;
    }

    .filter_select:focus {
        outline: none;
        border-color: #003d79;
    }

    .filter_input_small {
        width: 80px;
        padding: 8px;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter_separator {
        color: #999;
    }

    .btn_reset {
        padding: 8px 16px;
        background: #f5f7fa;
        color: #666;
        border: 1px solid #d0d7de;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }

    .btn_reset:hover {
        background: #e8eaed;
        border-color: #003d79;
        color: #003d79;
    }

    /* è¯¾ç¨‹åŒºåŸŸ */
    .courses_section {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 24px;
        margin-bottom: 30px;
    }

    .section_header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #003d79;
    }

    .section_title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .course_count {
        color: #003d79;
        font-weight: normal;
    }

    .courses_table_container {
        overflow-x: auto;
    }

    .courses_table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .courses_table th {
        background: linear-gradient(135deg, #003d79 0%, #0056b3 100%);
        color: #fff;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
    }

    .courses_table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        color: #333;
    }

    .courses_table tbody tr:hover {
        background: #f9fafb;
    }

    .empty_cell, .loading_cell {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    /* çŠ¶æ€æ ‡ç­¾ */
    .status_badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status_available {
        background: #f0f9ff;
        color: #1890ff;
    }

    .status_chosen {
        background: #f6ffed;
        color: #52c41a;
    }

    .status_full {
        background: #fff1f0;
        color: #f5222d;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn_action {
        padding: 6px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
    }

    .btn_select {
        background: #52c41a;
        color: #fff;
    }

    .btn_select:hover:not(:disabled) {
        background: #73d13d;
    }

    .btn_drop {
        background: #f5222d;
        color: #fff;
    }

    .btn_drop:hover:not(:disabled) {
        background: #ff4d4f;
    }

    .btn_action:disabled {
        background: #d9d9d9;
        color: #999;
        cursor: not-allowed;
    }

    .capacity_text {
        font-size: 13px;
        color: #666;
    }

    /* æ¶ˆæ¯æç¤º */
    .message_toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001;
        min-width: 250px;
        display: none;
        font-size: 14px;
    }

    .message_toast.success {
        background: #52c41a;
        color: #fff;
    }

    .message_toast.error {
        background: #f5222d;
        color: #fff;
    }

    /* è¯¾ç¨‹è¯¦æƒ…å¡ç‰‡ï¼ˆæœç´¢æ¡†ä¸‹æ–¹ï¼‰ */
    .course_detail_card {
        margin-top: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 2px solid #003d79;
        overflow: hidden;
    }

    .detail_card_header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(135deg, #003d79 0%, #0056b3 100%);
        color: #fff;
    }

    .detail_card_title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .detail_card_close {
        color: #fff;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        transition: transform 0.2s;
    }

    .detail_card_close:hover {
        transform: rotate(90deg);
    }

    .detail_card_body {
        padding: 20px;
    }

    .course_detail_info {
        padding: 0;
    }

    .detail_row {
        display: flex;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail_row:last-child {
        border-bottom: none;
    }

    .detail_label {
        width: 120px;
        font-weight: 600;
        color: #666;
        font-size: 14px;
        flex-shrink: 0;
    }

    .detail_value {
        flex: 1;
        color: #333;
        font-size: 14px;
    }

    .course_name {
        font-size: 16px;
        font-weight: 600;
        color: #003d79;
    }

    .detail_card_footer {
        padding: 15px 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: #f9fafb;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1280px) {
        .selection_container {
            width: 95%;
        }

        .status_summary_card {
            flex-direction: column;
        }

        .filter_row {
            flex-direction: column;
            align-items: stretch;
        }

        .search_box {
            min-width: auto;
        }
    }
    </style>
</body>
</html>
