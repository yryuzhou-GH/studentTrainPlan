<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="{{ url_for('static', filename='css/style1.css') }}" rel="stylesheet" type="text/css" />
<link rel="icon" href="{{ url_for('static', filename='images/logo.ico') }}" type="image/x-icon"/>
<script src="{{ url_for('static', filename='js/jquery1.42.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/jquery.js') }}"></script>
<title>è¯¾ç¨‹è®ºå›</title>
</head>

<body>
<div class="wapper_box">
    <div class="header_box"></div>
    <div class="header_box1">
        <div class="header_box2">
            <a class="logo_box" href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='images/logo1.jpg') }}"/></a>
            <ul class="nav_box">
                <li class="nav_1"><a class="nav_but" href="{{ url_for('personal_information') }}">ä¸ªäººä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('inbox') }}">æ¶ˆæ¯ä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('news_center') }}">è¯¾ç¨‹è®ºå›</a>
                    <div class="nav_slide">
                        <div class="nav_slide1">
                            <a href="{{ url_for('news_center') }}">è¯¾ç¨‹è®¨è®º<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
                            <a href="{{ url_for('course_discussion') }}">å‘å¸ƒè¯é¢˜<span><img src="{{ url_for('static', filename='images/siade_bg1.png') }}"/></span></a>
                        </div>
                    </div>
                </li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('recommed') }}">è¯¾ç¨‹æ¨è</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('course_selection') }}">é€‰è¯¾ä¸­å¿ƒ</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('train_plan') }}">è¯¾ç¨‹è¿›åº¦</a></li>
                <li class="nav_1"><a class="nav_but" href="{{ url_for('index') }}">é¦–é¡µ</a></li>
            </ul>
        </div>
        <script>
            $(".nav_1").mouseenter(function(){
                $(this).find(".nav_slide").slideDown()
            });
            $(".nav_1").mouseleave(function(){
                $(".nav_slide").slideUp()
            });
        </script>
    </div>

    <!-- è¯¾ç¨‹è®ºå›ä¸»ä½“å†…å®¹ -->
    <div class="forum_container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="forum_sidebar">
            <div class="sidebar_header">
                <h2 class="sidebar_title">è¯¾ç¨‹è®ºå›</h2>
            </div>
            <ul class="forum_menu">
                <li class="forum_menu_item {% if section == 'discussion' or not section %}active{% endif %}">
                    <a href="{{ url_for('news_center', section='discussion') }}">
                        <span class="menu_icon">ğŸ’¬</span>
                        <span class="menu_text">è¯¾ç¨‹è®¨è®º</span>
                    </a>
                </li>
                <li class="forum_menu_item">
                    <a href="{{ url_for('course_discussion') }}">
                        <span class="menu_icon">âœï¸</span>
                        <span class="menu_text">å‘å¸ƒè¯é¢˜</span>
                    </a>
                </li>
                <li class="forum_menu_item {% if section == 'my_topics' %}active{% endif %}">
                    <a href="{{ url_for('news_center', section='my_topics') }}">
                        <span class="menu_icon">ğŸ“</span>
                        <span class="menu_text">æˆ‘çš„è¯é¢˜</span>
                    </a>
                </li>
                <li class="forum_menu_item {% if section == 'hot' %}active{% endif %}">
                    <a href="{{ url_for('news_center', section='hot') }}">
                        <span class="menu_icon">ğŸ”¥</span>
                        <span class="menu_text">çƒ­é—¨è®¨è®º</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="forum_content">
            <!-- æ’åºå’Œç­›é€‰æ  -->
            <div class="forum_toolbar">
                <div class="sort_options">
                    <span class="toolbar_label">æ’åºï¼š</span>
                    <button class="sort_btn {% if sort_by == 'latest' or not sort_by %}active{% endif %}" data-sort="latest">æœ€æ–°å‘å¸ƒ</button>
                    <button class="sort_btn {% if sort_by == 'replies' %}active{% endif %}" data-sort="replies">å›å¤æœ€å¤š</button>
                    <button class="sort_btn {% if sort_by == 'my_participation' %}active{% endif %}" data-sort="my_participation">æˆ‘çš„å‚ä¸</button>
                </div>
            </div>

            <!-- è¯é¢˜åˆ—è¡¨ -->
            <div class="topics_list" id="topics-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination">
                <!-- åˆ†é¡µå†…å®¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<script>
$(function() {
    var currentPage = 1;
    var currentSort = 'latest';
    var currentFilter = '{{ section if section else "all" }}';
    
    // å°†sectionæ˜ å°„åˆ°filterå‚æ•°
    var sectionToFilter = {
        'discussion': 'all',
        'my_topics': 'my_topics',
        'hot': 'hot'
    };
    if (sectionToFilter[currentFilter]) {
        currentFilter = sectionToFilter[currentFilter];
    }
    
    // åŠ è½½è¯é¢˜åˆ—è¡¨
    function loadTopics(page, sortBy, filter) {
        currentPage = page || 1;
        currentSort = sortBy || 'latest';
        currentFilter = filter || currentFilter;
        
        $("#topics-list").html('<div class="loading">åŠ è½½ä¸­...</div>');
        
        $.ajax({
            url: "/api/get_discussion_topics",
            type: "GET",
            data: {
                page: currentPage,
                sort_by: currentSort,
                filter: currentFilter,
                per_page: 10
            },
            success: function(res) {
                if (res.success && res.data) {
                    renderTopics(res.data);
                    renderPagination(res.pagination);
                } else {
                    $("#topics-list").html('<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>');
                }
            },
            error: function() {
                $("#topics-list").html('<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>');
            }
        });
    }
    
    // æ¸²æŸ“è¯é¢˜åˆ—è¡¨
    function renderTopics(topics) {
        if (topics.length === 0) {
            $("#topics-list").html('<div class="empty_state">æš‚æ— è¯é¢˜</div>');
            return;
        }
        
        var html = '';
        topics.forEach(function(topic) {
            var tagsHtml = '';
            if (topic.tags && topic.tags.length > 0) {
                topic.tags.forEach(function(tag) {
                    var tagClass = 'tag_default';
                    if (tag === 'æœ€æ–°') tagClass = 'tag_new';
                    else if (tag === 'ç½®é¡¶') tagClass = 'tag_top';
                    else if (tag === 'æ•™å¸ˆå›å¤') tagClass = 'tag_teacher';
                    else if (tag === 'çƒ­é—¨') tagClass = 'tag_hot';
                    
                    tagsHtml += '<span class="topic_tag ' + tagClass + '">' + tag + '</span>';
                });
            }
            
            html += `
                <div class="topic_card">
                    <div class="topic_header">
                        <h3 class="topic_title">
                            <a href="/detail/${topic.news_id}">${topic.topic}</a>
                        </h3>
                        <div class="topic_tags">
                            ${tagsHtml}
                        </div>
                    </div>
                    <div class="topic_content">
                        ${topic.content}
                    </div>
                    <div class="topic_footer">
                        <div class="topic_meta">
                            <span class="meta_item">
                                <span class="meta_icon">ğŸ‘¤</span>
                                <span class="meta_text">${topic.commenter}</span>
                            </span>
                            <span class="meta_item">
                                <span class="meta_icon">ğŸ•</span>
                                <span class="meta_text">${topic.create_time || 'æœªçŸ¥æ—¶é—´'}</span>
                            </span>
                        </div>
                        <div class="topic_stats">
                            <span class="stat_item">
                                <span class="stat_icon">ğŸ’¬</span>
                                <span class="stat_text">${topic.reply_count} å›å¤</span>
                            </span>
                            <span class="stat_item">
                                <span class="stat_icon">ğŸ‘</span>
                                <span class="stat_text">${topic.view_count} æµè§ˆ</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $("#topics-list").html(html);
    }
    
    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(pagination) {
        if (!pagination || pagination.pages <= 1) {
            $("#pagination").html('');
            return;
        }
        
        var html = '<div class="pagination_content">';
        
        // ä¸Šä¸€é¡µ
        if (pagination.page > 1) {
            html += `<a href="javascript:void(0)" class="page_btn" data-page="${pagination.page - 1}">ä¸Šä¸€é¡µ</a>`;
        }
        
        // é¡µç 
        var startPage = Math.max(1, pagination.page - 2);
        var endPage = Math.min(pagination.pages, pagination.page + 2);
        
        if (startPage > 1) {
            html += `<a href="javascript:void(0)" class="page_btn" data-page="1">1</a>`;
            if (startPage > 2) {
                html += `<span class="page_ellipsis">...</span>`;
            }
        }
        
        for (var i = startPage; i <= endPage; i++) {
            var activeClass = i === pagination.page ? 'active' : '';
            html += `<a href="javascript:void(0)" class="page_btn ${activeClass}" data-page="${i}">${i}</a>`;
        }
        
        if (endPage < pagination.pages) {
            if (endPage < pagination.pages - 1) {
                html += `<span class="page_ellipsis">...</span>`;
            }
            html += `<a href="javascript:void(0)" class="page_btn" data-page="${pagination.pages}">${pagination.pages}</a>`;
        }
        
        // ä¸‹ä¸€é¡µ
        if (pagination.page < pagination.pages) {
            html += `<a href="javascript:void(0)" class="page_btn" data-page="${pagination.page + 1}">ä¸‹ä¸€é¡µ</a>`;
        }
        
        html += '</div>';
        $("#pagination").html(html);
    }
    
    // æ’åºæŒ‰é’®ç‚¹å‡»
    $(".sort_btn").click(function() {
        $(".sort_btn").removeClass("active");
        $(this).addClass("active");
        var sortBy = $(this).data("sort");
        loadTopics(1, sortBy, currentFilter);
    });
    
    // åˆ†é¡µç‚¹å‡»
    $(document).on("click", ".page_btn", function() {
        var page = $(this).data("page");
        loadTopics(page, currentSort, currentFilter);
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        $("html, body").animate({ scrollTop: 0 }, 300);
    });
    
    // è¯é¢˜å¡ç‰‡ç‚¹å‡»ç»Ÿè®¡ï¼ˆå¯é€‰ï¼Œç”¨äºç»Ÿè®¡æµè§ˆé‡ï¼‰
    $(document).on("click", ".topic_card", function(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯é“¾æ¥ï¼Œä¸é˜»æ­¢é»˜è®¤è¡Œä¸º
        if ($(e.target).closest("a").length > 0) {
            return;
        }
        // å¦åˆ™è·³è½¬åˆ°è¯¦æƒ…é¡µ
        var link = $(this).find(".topic_title a").attr("href");
        if (link) {
            window.location.href = link;
        }
    });
    
    // åˆå§‹åŒ–åŠ è½½
    loadTopics(1, currentSort, currentFilter);
    
    // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼ˆå¯é€‰ï¼Œæ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    // setInterval(function() {
    //     if (document.visibilityState === 'visible') {
    //         loadTopics(currentPage, currentSort, currentFilter);
    //     }
    // }, 30000);
});
</script>

<style>
/* è®ºå›å®¹å™¨ */
.forum_container {
    width: 1200px;
    margin: 30px auto;
    display: flex;
    gap: 20px;
    min-height: 600px;
}

/* å·¦ä¾§å¯¼èˆªæ  */
.forum_sidebar {
    width: 220px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}

.sidebar_header {
    padding: 20px;
    background: linear-gradient(135deg, #003d79 0%, #0056b3 100%);
    color: #fff;
}

.sidebar_title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.forum_menu {
    list-style: none;
    padding: 0;
    margin: 0;
}

.forum_menu_item {
    margin: 0;
}

.forum_menu_item a {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    color: #666;
    text-decoration: none;
    transition: all 0.3s;
    border-left: 3px solid transparent;
}

.forum_menu_item a:hover {
    background: #f5f7fa;
    color: #003d79;
}

.forum_menu_item.active a {
    background: #f0f4ff;
    color: #003d79;
    border-left-color: #003d79;
    font-weight: 500;
}

.forum_menu_item .menu_icon {
    font-size: 18px;
    margin-right: 12px;
    width: 24px;
    text-align: center;
}

.forum_menu_item .menu_text {
    font-size: 15px;
}

/* å³ä¾§å†…å®¹åŒº */
.forum_content {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 24px;
}

/* å·¥å…·æ  */
.forum_toolbar {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.sort_options {
    display: flex;
    align-items: center;
    gap: 10px;
}

.toolbar_label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.sort_btn {
    padding: 6px 16px;
    border: 1px solid #d0d7de;
    background: #fff;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.sort_btn:hover {
    border-color: #003d79;
    color: #003d79;
}

.sort_btn.active {
    background: #003d79;
    color: #fff;
    border-color: #003d79;
}

/* è¯é¢˜åˆ—è¡¨ */
.topics_list {
    min-height: 400px;
}

.topic_card {
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid #e8eaed;
    border-radius: 8px;
    background: #fff;
    transition: all 0.3s;
}

.topic_card:hover {
    box-shadow: 0 4px 12px rgba(0,61,121,0.1);
    border-color: #003d79;
    transform: translateY(-2px);
}

.topic_header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.topic_title {
    margin: 0;
    flex: 1;
}

.topic_title a {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    text-decoration: none;
    transition: color 0.3s;
}

.topic_title a:hover {
    color: #003d79;
}

.topic_tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.topic_tag {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.tag_new {
    background: #e6f7ff;
    color: #1890ff;
}

.tag_top {
    background: #fff7e6;
    color: #fa8c16;
}

.tag_teacher {
    background: #f6ffed;
    color: #52c41a;
}

.tag_hot {
    background: #fff1f0;
    color: #f5222d;
}

.tag_default {
    background: #f5f5f5;
    color: #666;
}

.topic_content {
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 15px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.topic_footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.topic_meta {
    display: flex;
    gap: 20px;
}

.meta_item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #999;
}

.meta_icon {
    font-size: 14px;
}

.topic_stats {
    display: flex;
    gap: 20px;
}

.stat_item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #666;
}

.stat_icon {
    font-size: 14px;
}

/* åˆ†é¡µ */
.pagination {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
}

.pagination_content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.page_btn {
    padding: 8px 12px;
    border: 1px solid #d0d7de;
    background: #fff;
    color: #666;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.3s;
    cursor: pointer;
}

.page_btn:hover {
    border-color: #003d79;
    color: #003d79;
}

.page_btn.active {
    background: #003d79;
    color: #fff;
    border-color: #003d79;
}

.page_ellipsis {
    padding: 8px 4px;
    color: #999;
}

/* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
.loading, .error, .empty_state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
    font-size: 14px;
}

.error {
    color: #f56c6c;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1280px) {
    .forum_container {
        width: 95%;
        flex-direction: column;
    }

    .forum_sidebar {
        width: 100%;
    }

    .forum_menu {
        display: flex;
        overflow-x: auto;
    }

    .forum_menu_item {
        flex-shrink: 0;
    }
}
</style>

</body>
</html>
