# 选课中心选课功能流程图

## 📋 目录
- [选课中心选课功能流程图](#选课中心选课功能流程图)
  - [📋 目录](#-目录)
  - [整体流程图](#整体流程图)
  - [详细步骤说明](#详细步骤说明)
    - [1. 页面初始化流程](#1-页面初始化流程)
    - [2. 搜索/筛选流程](#2-搜索筛选流程)
    - [3. 选课核心流程](#3-选课核心流程)
  - [数据流图](#数据流图)
  - [关键验证点](#关键验证点)
  - [错误处理](#错误处理)
  - [成功后的操作](#成功后的操作)

## 整体流程图

```mermaid
flowchart TD
    Start([用户进入选课中心页面]) --> LoadPage[页面加载]
    LoadPage --> LoadData[加载初始数据]
    LoadData --> LoadAvailable[获取可选课程列表<br/>get_available_elective_courses]
    LoadData --> LoadChosen[获取已选课程列表<br/>get_student_chosen_courses]
    LoadData --> LoadStats[加载选课统计信息<br/>/api/get_selection_statistics]
    
    LoadAvailable --> DisplayPage[显示页面内容]
    LoadChosen --> DisplayPage
    LoadStats --> DisplayPage
    
    DisplayPage --> UserAction{用户操作}
    
    UserAction -->|搜索/筛选| SearchFilter[输入搜索关键词或选择筛选条件]
    SearchFilter --> ApplyFilter[调用 applyFilters 函数]
    ApplyFilter --> AJAXFilter[AJAX请求<br/>GET /api/get_filtered_courses]
    AJAXFilter --> RenderList[渲染可选课程列表]
    RenderList --> DisplayPage
    
    UserAction -->|点击选课按钮| ClickSelect[点击选课按钮]
    ClickSelect --> Confirm[显示确认对话框<br/>confirm 确认]
    Confirm -->|取消| DisplayPage
    Confirm -->|确认| DisableBtn[禁用按钮<br/>显示'选课中...']
    DisableBtn --> AJAXSelect[AJAX请求<br/>POST /api/select_course<br/>JSON: {co_no: 课程编号}]
    
    AJAXSelect --> CheckLogin{检查登录状态}
    CheckLogin -->|未登录| Return401[返回 401<br/>用户未登录]
    CheckLogin -->|已登录| ValidateData{验证请求数据}
    
    ValidateData -->|数据无效| Return400[返回 400<br/>课程编号不能为空]
    ValidateData -->|数据有效| CallSelect[调用 select_course 函数<br/>utils/course_selection.py]
    
    CallSelect --> CheckCourse{检查课程是否存在}
    CheckCourse -->|不存在| ReturnError1[返回错误<br/>课程不存在]
    CheckCourse -->|存在| CheckChosen{检查是否已选}
    
    CheckChosen -->|已选过| ReturnError2[返回错误<br/>您已经选过该课程了]
    CheckChosen -->|未选过| CheckCapacity{检查课程容量}
    
    CheckCapacity -->|已满员| ReturnError3[返回错误<br/>课程已满员]
    CheckCapacity -->|未满员| InsertDB[插入选课记录<br/>INSERT INTO CHOOSE]
    
    InsertDB --> CheckInsert{插入是否成功}
    CheckInsert -->|失败| ReturnError4[返回错误<br/>选课失败 + 错误信息]
    CheckInsert -->|成功| ReturnSuccess[返回成功<br/>成功选择课程]
    
    ReturnSuccess --> ShowSuccess[前端显示成功消息<br/>showMessage]
    ShowSuccess --> ReloadPage[1秒后刷新页面<br/>location.reload]
    ReloadPage --> LoadPage
    
    ReturnError1 --> ShowError[前端显示错误消息]
    ReturnError2 --> ShowError
    ReturnError3 --> ShowError
    ReturnError4 --> ShowError
    Return401 --> ShowError
    Return400 --> ShowError
    
    ShowError --> EnableBtn[恢复按钮状态<br/>显示'选课']
    EnableBtn --> DisplayPage
```

## 详细步骤说明

### 1. 页面初始化流程

```
用户访问 /course_selection
    ↓
后端路由 course_selection()
    ↓
检查登录状态 (session.get('stu_id'))
    ↓
    ├─ 未登录 → 重定向到登录页
    └─ 已登录 → 继续
    ↓
获取可选课程列表
    ├─ 调用 get_available_elective_courses(stu_no)
    │   ├─ 查询所有专业选修课程 (EDUCATION_PLAN)
    │   ├─ 查询学生已选课程 (CHOOSE)
    │   └─ 筛选出未选的课程
    │
    └─ 获取已选课程列表
        └─ 调用 get_student_chosen_courses(stu_no)
            └─ 查询学生已选的专业选修课程
    ↓
渲染页面模板
    └─ course_selection.html
    ↓
前端 JavaScript 初始化
    ├─ loadStatistics() - 加载选课统计
    ├─ loadChosenCoursesDetails() - 加载已选课程详情
    └─ 绑定事件监听器
```

### 2. 搜索/筛选流程

```
用户输入搜索关键词或选择筛选条件
    ↓
触发 applyFilters() 函数
    ↓
收集筛选参数
    ├─ keyword: 搜索关键词
    ├─ college: 学院
    ├─ course_type: 课程类型
    ├─ credits_min/max: 学分范围
    └─ class_time: 上课时间
    ↓
显示加载状态 ("加载中...")
    ↓
AJAX 请求 GET /api/get_filtered_courses
    ↓
后端处理
    ├─ 检查登录状态
    ├─ 构建 SQL 查询（根据筛选条件）
    ├─ 执行查询
    ├─ 计算课程状态（可选/已选/已满）
    └─ 返回 JSON 数据
    ↓
前端接收响应
    ↓
调用 renderAvailableCourses() 渲染列表
    ↓
更新页面显示
```

### 3. 选课核心流程

```
用户点击"选课"按钮
    ↓
触发 selectCourse(coNo, coName) 函数
    ↓
显示确认对话框
    "确定要选择课程《课程名》吗？
     提示：选课后，推荐系统会根据您的选课信息动态更新推荐结果。"
    ↓
    ├─ 用户取消 → 结束
    └─ 用户确认 → 继续
    ↓
禁用按钮，显示"选课中..."
    ↓
AJAX 请求 POST /api/select_course
    Content-Type: application/json
    Body: { "co_no": "课程编号" }
    ↓
后端路由 api_select_course()
    ├─ 检查登录状态
    │   └─ 未登录 → 返回 401
    ├─ 解析 JSON 数据
    │   └─ 数据无效 → 返回 400
    └─ 调用 select_course(stu_no, co_no)
    ↓
选课业务逻辑 (utils/course_selection.py)
    ├─ 步骤1: 检查课程是否存在
    │   SQL: SELECT CO_NO, CO_NAME, MAX_STUDENTS 
    │        FROM EDUCATION_PLAN 
    │        WHERE CO_NO = '课程编号'
    │   └─ 不存在 → 返回 (False, "课程不存在")
    │
    ├─ 步骤2: 检查是否已选过
    │   SQL: SELECT CO_NO FROM CHOOSE 
    │        WHERE STU_NO = '学号' AND CO_NO = '课程编号'
    │   └─ 已选过 → 返回 (False, "您已经选过该课程了")
    │
    ├─ 步骤3: 检查课程容量
    │   IF MAX_STUDENTS > 0:
    │       SQL: SELECT COUNT(*) FROM CHOOSE WHERE CO_NO = '课程编号'
    │       └─ 当前人数 >= 最大人数 → 返回 (False, "课程已满员")
    │
    └─ 步骤4: 插入选课记录
        SQL: INSERT INTO CHOOSE (AD_YEAR, MAJOR, STU_NO, CO_NO, GRADE, COMMENT)
             VALUES ('2016', '计算机科学与技术', '学号', '课程编号', NULL, NULL)
        └─ 成功 → 返回 (True, "成功选择课程《课程名》")
        └─ 失败 → 返回 (False, "选课失败：错误信息")
    ↓
后端返回 JSON 响应
    ├─ 成功: { "success": true, "message": "成功选择课程..." }
    └─ 失败: { "success": false, "message": "错误信息" }
    ↓
前端处理响应
    ├─ 成功:
    │   ├─ 显示成功消息 "成功选择课程... 推荐系统已自动更新！"
    │   └─ 1秒后刷新页面 (location.reload)
    │
    └─ 失败:
        ├─ 显示错误消息
        └─ 恢复按钮状态 ("选课")
    ↓
页面刷新后重新加载数据
    └─ 已选课程列表更新，可选课程列表更新
```

## 数据流图

```
┌─────────────┐
│   前端页面   │
│course_selection.html
└──────┬──────┘
       │
       │ 1. 页面加载
       ↓
┌─────────────────────┐
│  GET /course_selection │
│  (Flask 路由)        │
└──────┬──────────────┘
       │
       │ 2. 获取数据
       ↓
┌─────────────────────┐
│ get_available_elective_courses() │
│ get_student_chosen_courses()     │
└──────┬──────────────┘
       │
       │ 3. 查询数据库
       ↓
┌─────────────────────┐
│   MySQL 数据库      │
│  - EDUCATION_PLAN   │
│  - CHOOSE           │
└─────────────────────┘

┌─────────────┐
│   用户操作   │
│ 点击选课按钮 │
└──────┬──────┘
       │
       │ 4. AJAX 请求
       ↓
┌─────────────────────┐
│ POST /api/select_course │
│ { "co_no": "..." }  │
└──────┬──────────────┘
       │
       │ 5. 调用业务逻辑
       ↓
┌─────────────────────┐
│ select_course()      │
│ (utils/course_selection.py) │
└──────┬──────────────┘
       │
       │ 6. 数据库操作
       ↓
┌─────────────────────┐
│   MySQL 数据库      │
│  INSERT INTO CHOOSE │
└──────┬──────────────┘
       │
       │ 7. 返回结果
       ↓
┌─────────────────────┐
│ JSON 响应           │
│ { "success": true } │
└──────┬──────────────┘
       │
       │ 8. 更新界面
       ↓
┌─────────────┐
│   前端页面   │
│ 显示消息并刷新 │
└─────────────┘
```

## 关键验证点

1. **登录验证**: `session.get('stu_id')` 检查用户是否登录
2. **课程存在性验证**: 查询 `EDUCATION_PLAN` 表确认课程存在
3. **重复选课验证**: 查询 `CHOOSE` 表检查是否已选过
4. **容量验证**: 比较当前选课人数和最大容量
5. **数据完整性**: 插入记录时包含必要字段（AD_YEAR, MAJOR, STU_NO, CO_NO）

## 错误处理

- **401 未登录**: 用户未登录，需要先登录
- **400 参数错误**: 课程编号为空或请求数据格式错误
- **课程不存在**: 数据库中找不到该课程
- **已选过**: 学生已经选过该课程
- **已满员**: 课程容量已满，无法再选
- **数据库错误**: 插入记录时发生异常

## 成功后的操作

1. 显示成功提示消息
2. 1秒后自动刷新页面
3. 重新加载已选课程列表
4. 重新加载可选课程列表
5. 更新选课统计信息
6. 推荐系统自动更新（通过页面刷新触发）

